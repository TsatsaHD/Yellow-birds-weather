<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Airport Weather</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body {
      background-color: #ffc107;
      color: #d40511;
    }
    button {
      background-color: #d40511;
      color: #ffff00;
      width: 100%;
      text-align: center;
    }
    button:hover {
      background-color: #b0040e;
    }
    #weather-data {
      background-color: rgba(255, 255, 255, 0.9);
      color: #000000;
    }
    .highlight-red {
      background-color: #d40511;
      color: #ffffff;
      padding: 2px 4px;
      border-radius: 2px;
    }
    .highlight-orange {
      background-color: #f28c38;
      color: #ffffff;
      padding: 2px 4px;
      border-radius: 2px;
    }
    .grid-container {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 0.5rem;
      padding: 1rem;
      max-width: 1200px;
      width: 100%;
      box-sizing: border-box;
    }
    @media (max-width: 640px) {
      .grid-container {
        grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
        padding: 0.5rem;
      }
    }
  </style>
</head>
<body class="flex flex-col items-center justify-center min-h-screen p-4">
  <h1 class="text-3xl font-bold mb-6">Airport Weather Information</h1>

  <div class="grid-container">
    <button onclick="fetchWeather('EHAM', 'Amsterdam (AMS)')" class="px-4 py-2 rounded-lg font-semibold">Amsterdam (AMS)</button>
    <button onclick="fetchWeather('OBBI', 'Bahrain (BAH)')" class="px-4 py-2 rounded-lg font-semibold">Bahrain (BAH)</button>
    <button onclick="fetchWeather('LEBL', 'Barcelona (BCN)')" class="px-4 py-2 rounded-lg font-semibold">Barcelona (BCN)</button>
    <button onclick="fetchWeather('LFSB', 'Basel/Mulhouse (BSL/MLH)')" class="px-4 py-2 rounded-lg font-semibold">Basel/Mulhouse (BSL/MLH)</button>
    <button onclick="fetchWeather('LIPE', 'Bologna (BLQ)')" class="px-4 py-2 rounded-lg font-semibold">Bologna (BLQ)</button>
    <button onclick="fetchWeather('LFBD', 'Bordeaux (BOD)')" class="px-4 py-2 rounded-lg font-semibold">Bordeaux (BOD)</button>
    <button onclick="fetchWeather('EBBR', 'Brussels (BRU)')" class="px-4 py-2 rounded-lg font-semibold">Brussels (BRU)</button>
    <button onclick="fetchWeather('LHBP', 'Budapest (BUD)')" class="px-4 py-2 rounded-lg font-semibold">Budapest (BUD)</button>
    <button onclick="fetchWeather('GMMN', 'Casablanca (CMN)')" class="px-4 py-2 rounded-lg font-semibold">Casablanca (CMN)</button>
    <button onclick="fetchWeather('KCVG', 'Cincinnati (CVG)')" class="px-4 py-2 rounded-lg font-semibold">Cincinnati (CVG)</button>
    <button onclick="fetchWeather('EDDK', 'Cologne (CGN)')" class="px-4 py-2 rounded-lg font-semibold">Cologne (CGN)</button>
    <button onclick="fetchWeather('EKCH', 'Copenhagen (CPH)')" class="px-4 py-2 rounded-lg font-semibold">Copenhagen (CPH)</button>
    <button onclick="fetchWeather('EIDW', 'Dublin (DUB)')" class="px-4 py-2 rounded-lg font-semibold">Dublin (DUB)</button>
    <button onclick="fetchWeather('EGNX', 'East Midlands (EMA)')" class="px-4 py-2 rounded-lg font-semibold">East Midlands (EMA)</button>
    <button onclick="fetchWeather('VHHH', 'Hong Kong (HKG)')" class="px-4 py-2 rounded-lg font-semibold">Hong Kong (HKG)</button>
    <button onclick="fetchWeather('DNMM', 'Lagos (LOS)')" class="px-4 py-2 rounded-lg font-semibold">Lagos (LOS)</button>
    <button onclick="fetchWeather('EDDP', 'Leipzig (LEJ)')" class="px-4 py-2 rounded-lg font-semibold">Leipzig (LEJ)</button>
    <button onclick="fetchWeather('LOWL', 'Linz (LNZ)')" class="px-4 py-2 rounded-lg font-semibold">Linz (LNZ)</button>
    <button onclick="fetchWeather('EGLL', 'London Heathrow (LHR)')" class="px-4 py-2 rounded-lg font-semibold">London Heathrow (LHR)</button>
    <button onclick="fetchWeather('EGGW', 'Luton (LTN)')" class="px-4 py-2 rounded-lg font-semibold">Luton (LTN)</button>
    <button onclick="fetchWeather('LFLL', 'Lyon (LYS)')" class="px-4 py-2 rounded-lg font-semibold">Lyon (LYS)</button>
    <button onclick="fetchWeather('LEMD', 'Madrid (MAD)')" class="px-4 py-2 rounded-lg font-semibold">Madrid (MAD)</button>
    <button onclick="fetchWeather('LFML', 'Marseille (MRS)')" class="px-4 py-2 rounded-lg font-semibold">Marseille (MRS)</button>
    <button onclick="fetchWeather('LIMC', 'Milan Malpensa (MXP)')" class="px-4 py-2 rounded-lg font-semibold">Milan Malpensa (MXP)</button>
    <button onclick="fetchWeather('LFPG', 'Paris CDG (CDG)')" class="px-4 py-2 rounded-lg font-semibold">Paris CDG (CDG)</button>
    <button onclick="fetchWeather('LPPR', 'Porto (OPO)')" class="px-4 py-2 rounded-lg font-semibold">Porto (OPO)</button>
    <button onclick="fetchWeather('OERK', 'Riyadh (RUH)')" class="px-4 py-2 rounded-lg font-semibold">Riyadh (RUH)</button>
    <button onclick="fetchWeather('ZSPD', 'Shanghai (PVG)')" class="px-4 py-2 rounded-lg font-semibold">Shanghai (PVG)</button>
    <button onclick="fetchWeather('ZGSZ', 'Shenzhen (SZX)')" class="px-4 py-2 rounded-lg font-semibold">Shenzhen (SZX)</button>
    <button onclick="fetchWeather('LLBG', 'Tel Aviv (TLV)')" class="px-4 py-2 rounded-lg font-semibold">Tel Aviv (TLV)</button>
    <button onclick="fetchWeather('LFBO', 'Toulouse (TLS)')" class="px-4 py-2 rounded-lg font-semibold">Toulouse (TLS)</button>
    <button onclick="fetchWeather('LEVT', 'Vitoria (VIT)')" class="px-4 py-2 rounded-lg font-semibold">Vitoria (VIT)</button>
  </div>
  <div id="weather-data" class="w-full max-w-2xl p-6 rounded-lg shadow-lg mt-6">
    <p>Select an airport to view decoded METAR and TAF data.</p>
  </div>

  <script>
    const weatherTranslations = {
      'BR': 'mist',
      'TS': 'thunderstorm',
      'FG': 'fog',
      'HZ': 'haze',
      'FU': 'smoke',
      'FZ': 'freezing',
      'VA': 'volcanic ash',
      'DU': 'widespread dust',
      'SQ': 'squall',
      'FC': 'funnel cloud',
      'PO': 'dust devils',
      'SA': 'sand',
      'CB': 'cumulonimbus',
      'TCU': 'towering cumulus',
      'WS': 'wind shear',
      '+': 'heavy ',
      '-': 'light ',
      'VC': 'in the vicinity ',
      'FZRA': 'freezing rain',
      'NSW': 'no significant weather',
      'ALQDS': 'all quadrants',
      'FM': 'from',
      'VRB': 'variable direction',
      'BCFG': 'patches of fog',
      'MIFG': 'shallow fog',
      'PRFG': 'partial fog',
      'DRSN': 'drifting snow',
      'BLSN': 'blowing snow',
      'MIBR': 'shallow mist',
      'PRBR': 'partial mist',
      'DRDU': 'drifting dust',
      'DRSA': 'drifting sand',
      'BLDU': 'blowing dust',
      'BLSA': 'blowing sand',
      'BECMG': 'becoming',
      'BECM': 'becoming',
      'TEMPO': 'temporary fluctuations',
      'TEMP': 'temporary fluctuations',
      'PROB30': '30% chance',
      'PROB40': '40% chance',
      'NOSIG': 'no significant change expected',
      '-RA': 'light rain',
      '+RA': 'heavy rain',
      'RA': 'rain',
      '-DZ': 'light drizzle',
      '+DZ': 'heavy drizzle',
      'DZ': 'drizzle',
      '-SN': 'light snow',
      '+SN': 'heavy snow',
      'SN': 'snow',
      '-SG': 'light snow grains',
      '+SG': 'heavy snow grains',
      'SG': 'snow grains',
      '-IC': 'light ice crystals',
      '+IC': 'heavy ice crystals',
      'IC': 'ice crystals',
      '-PL': 'light ice pellets',
      '+PL': 'heavy ice pellets',
      'PL': 'ice pellets',
      '-GR': 'light hail',
      '+GR': 'heavy hail',
      'GR': 'hail',
      '-GS': 'light small hail or snow pellets',
      '+GS': 'heavy small hail or snow pellets',
      'GS': 'small hail or snow pellets',
      '-UP': 'light unknown precipitation',
      '+UP': 'heavy unknown precipitation',
      'UP': 'unknown precipitation',
      '-FG': 'light fog',
      '+FG': 'dense fog',
      'FG': 'fog',
      '-SS': 'light sandstorm',
      '+SS': 'heavy sandstorm',
      '-DS': 'light duststorm',
      'SS': 'sandstorm',
      'DS': 'duststorm',
      '+DS': 'heavy duststorm',
      'SHRA': 'rain showers',
      '-SHRA': 'light rain showers',
      '+SHRA': 'heavy rain showers',
      '-SHSN': 'light snow showers',
      'SHSN': 'snow showers',
      '+SHSN': 'heavy snow showers',
      '-TSRA': 'thunderstorm with light rain',
      '+TSRA': 'thunderstorm with heavy rain',
      '-TSSN': 'thunderstorm with light snow',
      'TSRA': 'thunderstorm with rain',
      'TSSN': 'thunderstorm with snow',
      '+TSSN': 'thunderstorm with heavy snow',
      '-TSGR': 'thunderstorm with light hail',
      '+TSGR': 'thunderstorm with heavy hail',
      'TSGR': 'thunderstorm with hail',
    };

    const months = ['january', 'february', 'march', 'april', 'may', 'june', 'july', 'august', 'september', 'october', 'november', 'december'];

    function escapeRegExp(str) {
      return str.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
    }

    function decodeWeather(wxString) {
      if (!wxString) return 'none';
const codes = wxString.match(/PROB(?:30|40)|[+-]?[A-Z]{2,4}/g) || [];
      return codes.map(code => weatherTranslations[code] || code).join(', ');
    }

    function highlightText(text) {
  const orangeList = ['mist', 'shallow mist', 'partial mist']; 
  const ignoreList = [
    'rain',
    'light rain',
    'heavy rain',
    'rain showers',
    'light rain showers',
    'heavy rain showers',
    'drizzle',
    'light drizzle',
    'heavy drizzle',
    'light ',
    'no significant weather',
    'no significant change expected'
  ];

  let highlighted = text;

  Object.values(weatherTranslations).forEach(condition => {
    if (!condition) return;
    const regex = new RegExp(`\\b${escapeRegExp(condition)}\\b`, 'gi');

    if (orangeList.includes(condition.toLowerCase())) {
      highlighted = highlighted.replace(regex, `<span class="highlight-orange">${condition}</span>`);
    } else if (!ignoreList.includes(condition.toLowerCase())) {
      highlighted = highlighted.replace(regex, `<span class="highlight-red">${condition}</span>`);
    }
  });

  return highlighted;
}

    function decodeCloudCover(cover) {
      switch (cover) {
        case 'FEW': return 'few clouds';
        case 'SCT': return 'scattered clouds';
        case 'BKN': return 'broken clouds';
        case 'OVC': return 'overcast';
        case 'NSC': return 'no significant clouds';
        case 'CAVOK': return 'ceiling and visibility ok';
        case 'CLR': return 'clear';
        case 'SKC': return 'sky clear';
        default: return cover;
      }
    }

    function formatTime(isoTime) {
      if (!isoTime) return 'Unknown';
      const date = new Date(isoTime);
      const day = date.getUTCDate().toString().padStart(2, '0');
      const month = months[date.getUTCMonth()];
      const hours = date.getUTCHours().toString().padStart(2, '0');
      const minutes = date.getUTCMinutes().toString().padStart(2, '0');
      return `${day} ${month} ${hours}:${minutes} UTC`;
    }

    function isInPast(isoTime) {
      if (!isoTime) return false;
      const currentTime = new Date();
      const time = new Date(isoTime);
      return time < currentTime;
    }

    async function fetchWeather(icao, airportName) {
      const weatherDiv = document.getElementById('weather-data');
      weatherDiv.innerHTML = '<p>Loading...</p>';

      try {
        // Fetch METAR using updated 2025 AviationWeather API endpoint
        const metarResponse = await fetch(`https://aviationweather.gov/api/data/metar?ids=${icao}&format=xml`);
        if (!metarResponse.ok) throw new Error(`METAR fetch failed: ${metarResponse.status}`);
        const metarText = await metarResponse.text();
        const metarParser = new DOMParser();
        const metarXml = metarParser.parseFromString(metarText, 'text/xml');
        const metarNode = metarXml.querySelector('METAR');
        let metarDecoded = 'No METAR data available';
        if (metarNode) {
          const observationTime = formatTime(metarNode.querySelector('observation_time')?.textContent);
          let wind = metarNode.querySelector('wind_speed_kt')?.textContent || 'Unknown';
          const windDir = metarNode.querySelector('wind_dir_degrees')?.textContent || '';
          const windGust = metarNode.querySelector('wind_gust_kt')?.textContent || null;
          let visibility = metarNode.querySelector('visibility_statute_mi')?.textContent || '10';
          const visibilityKm = isNaN(parseFloat(visibility)) ? visibility : parseFloat(visibility) * 1.60934;
          const temp = metarNode.querySelector('temp_c')?.textContent || 'Unknown';
          const dewpoint = metarNode.querySelector('dewpoint_c')?.textContent || 'Unknown';
          const pressureInHg = metarNode.querySelector('altim_in_hg')?.textContent || 'Unknown';
          const pressure = pressureInHg !== 'Unknown' ? (parseFloat(pressureInHg) * 33.8639).toFixed(0) : 'Unknown';
          const clouds = metarNode.querySelectorAll('sky_condition');
          let cloudLayers = [];
          let lowestCeiling = null;
          let hasCavok = false;
          clouds.forEach(cloud => {
            const cover = cloud.getAttribute('sky_cover');
            const baseStr = cloud.getAttribute('cloud_base_ft_agl');
            const base = baseStr ? parseInt(baseStr) : null;
            if (cover === 'CAVOK') hasCavok = true;
            if ((cover === 'BKN' || cover === 'OVC') && base && (!lowestCeiling || base < lowestCeiling)) {
              lowestCeiling = base;
            }
            const decodedCover = decodeCloudCover(cover).toLowerCase();
            cloudLayers.push(decodedCover + (base ? ` at ${base} ft` : ''));
          });
          let cloudText = cloudLayers.join(', ') || 'clear';
          const wxString = metarNode.querySelector('wx_string')?.textContent || '';

          // Apply highlighting
          let visibilityText = typeof visibilityKm === 'number' ? `${visibilityKm.toFixed(1)} km` : visibilityKm;
          if (typeof visibilityKm === 'number' && visibilityKm <= 0.56) visibilityText = `<span class="highlight-red">${visibilityText}</span>`;
          else if (typeof visibilityKm === 'number' && visibilityKm <= 0.81) visibilityText = `<span class="highlight-orange">${visibilityText}</span>`;
          
          if (wind !== 'Unknown') {
            if (windDir === 'VRB') {
              wind = `${wind} kt variable direction`;
            } else {
              const windSpeed = parseInt(wind);
              if (windSpeed >= 26) wind = `<span class="highlight-red">${windSpeed} kt from ${windDir}°</span>`;
              else if (windSpeed >= 21) wind = `<span class="highlight-orange">${windSpeed} kt from ${windDir}°</span>`;
              else wind = `${windSpeed} kt from ${windDir}°`;
            }
          }
          
          if (windGust) {
            const gustSpeed = parseInt(windGust);
            if (gustSpeed >= 36) wind += `, gusts <span class="highlight-red">${gustSpeed} kt</span>`;
            else if (gustSpeed >= 25) wind += `, gusts <span class="highlight-orange">${gustSpeed} kt</span>`;
          }
          
          if (lowestCeiling) {
            if (lowestCeiling <= 200) cloudText = `<span class="highlight-red">${cloudText}</span>`;
            else if (lowestCeiling <= 399) cloudText = `<span class="highlight-orange">${cloudText}</span>`;
          }
          
          const decodedWx = decodeWeather(wxString);
          const highlightedWx = highlightText(decodedWx, Object.values(weatherTranslations), 'highlight-red');

          if (hasCavok) {
            visibilityText = '10 km or more';
            cloudText = 'ceiling and visibility ok';
          }

          metarDecoded = `
            Observation time: ${observationTime}<br>
            ${wind && wind !== 'Unknown' ? `Wind: ${wind}<br>` : ''}
            Visibility: ${visibilityText}<br>
            Clouds: ${cloudText}<br>
            ${highlightedWx && highlightedWx !== 'none' ? `Weather: ${highlightedWx}<br>` : ''}
            Temperature & Dewpoint: ${temp}°C / ${dewpoint}°C<br>
            Pressure: ${pressure} hPa
          `;
        }

        // Fetch TAF using updated 2025 AviationWeather API endpoint
        const tafResponse = await fetch(`https://aviationweather.gov/api/data/taf?ids=${icao}&format=xml`);
        if (!tafResponse.ok) throw new Error(`TAF fetch failed: ${tafResponse.status}`);
        const tafText = await tafResponse.text();
        const tafParser = new DOMParser();
        const tafXml = tafParser.parseFromString(tafText, 'text/xml');
        const tafNode = tafXml.querySelector('TAF');
        let tafDecoded = 'No TAF data available';
        if (tafNode) {
          const forecast = [];
          const fcstGroups = tafNode.querySelectorAll('forecast');
          fcstGroups.forEach(fc => {
            const timeTo = fc.querySelector('fcst_time_to')?.textContent;
            if (isInPast(timeTo)) return; // Skip past forecast periods
            const timeFrom = formatTime(fc.querySelector('fcst_time_from')?.textContent);
            const timeToText = formatTime(timeTo);
            let wind = fc.querySelector('wind_speed_kt')?.textContent || 'Unknown';
            const windDir = fc.querySelector('wind_dir_degrees')?.textContent || '';
            const windGust = fc.querySelector('wind_gust_kt')?.textContent || null;
            let visibility = fc.querySelector('visibility_statute_mi')?.textContent || '10';
            const visibilityKm = isNaN(parseFloat(visibility)) ? visibility : parseFloat(visibility) * 1.60934;
            const clouds = fc.querySelectorAll('sky_condition');
            let cloudLayers = [];
            let lowestCeiling = null;
            let hasCavok = false;
            clouds.forEach(cloud => {
              const cover = cloud.getAttribute('sky_cover');
              const baseStr = cloud.getAttribute('cloud_base_ft_agl');
              const base = baseStr ? parseInt(baseStr) : null;
              if (cover === 'CAVOK') hasCavok = true;
              if ((cover === 'BKN' || cover === 'OVC') && base && (!lowestCeiling || base < lowestCeiling)) {
                lowestCeiling = base;
              }
              const decodedCover = decodeCloudCover(cover).toLowerCase();
              cloudLayers.push(decodedCover + (base ? ` at ${base} ft` : ''));
            });
            let cloudText = cloudLayers.join(', ') || 'clear';
            const wxString = fc.querySelector('wx_string')?.textContent || '';
            const changeIndicator = fc.querySelector('change_indicator')?.textContent || '';
            const change = changeIndicator ? decodeWeather(changeIndicator) + ' ' : '';

            let visibilityText = typeof visibilityKm === 'number' ? `${visibilityKm.toFixed(1)} km` : visibilityKm;
            if (typeof visibilityKm === 'number' && visibilityKm <= 0.56) visibilityText = `<span class="highlight-red">${visibilityText}</span>`;
            else if (typeof visibilityKm === 'number' && visibilityKm <= 0.81) visibilityText = `<span class="highlight-orange">${visibilityText}</span>`;
              
            if (wind !== 'Unknown') {
              if (windDir === 'VRB') {
                wind = `${wind} kt variable direction`;
              } else {
                const windSpeed = parseInt(wind);
                if (windSpeed >= 26) wind = `<span class="highlight-red">${windSpeed} kt from ${windDir}°</span>`;
                else if (windSpeed >= 21) wind = `<span class="highlight-orange">${windSpeed} kt from ${windDir}°</span>`;
                else wind = `${windSpeed} kt from ${windDir}°`;
              }
            }
              
            if (windGust) {
              const gustSpeed = parseInt(windGust);
              if (gustSpeed >= 36) wind += `, gusts <span class="highlight-red">${gustSpeed} kt</span>`;
              else if (gustSpeed >= 25) wind += `, gusts <span class="highlight-orange">${gustSpeed} kt</span>`;
            }
              
            if (lowestCeiling) {
              if (lowestCeiling <= 200) cloudText = `<span class="highlight-red">${cloudText}</span>`;
              else if (lowestCeiling <= 399) cloudText = `<span class="highlight-orange">${cloudText}</span>`;
            }
              
            const decodedWx = decodeWeather(wxString);
            const highlightedWx = highlightText(decodedWx, Object.values(weatherTranslations), 'highlight-red');

            if (hasCavok) {
              visibilityText = '10 km or more';
              cloudText = 'ceiling and visibility ok';
            }

            forecast.push(`
              ${change}${timeFrom} to ${timeToText}:<br>
              ${wind && wind !== 'Unknown' ? `&nbsp;&nbsp;Wind: ${wind}<br>` : ''}
              &nbsp;&nbsp;Visibility: ${visibilityText}<br>
              &nbsp;&nbsp;Clouds: ${cloudText}<br>
              ${highlightedWx && highlightedWx !== 'none' ? `&nbsp;&nbsp;Weather: ${highlightedWx}<br>` : ''}
            `);
          });
          tafDecoded = forecast.length > 0 ? forecast.join('\n<br>\n') : 'No TAF data available';
        }

        weatherDiv.innerHTML = `
          <h2 class="text-xl font-bold mb-2 text-[#D40511]">${airportName} Weather Data</h2>
          <h3 class="font-semibold">Decoded METAR</h3>
          <p>${metarDecoded.trim()}</p>

          <br>

          <h3 class="font-semibold mt-4">Decoded TAF</h3>
          <p>${tafDecoded.trim()}</p>
        `;
      } catch (error) {
        weatherDiv.innerHTML = `<p>Error fetching data: ${error.message}</p>`;
      }
    }
  </script>
</body>
</html>
