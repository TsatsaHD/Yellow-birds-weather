<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Airport Weather</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body {
      background-color: #ffc107;
      color: #d40511;
    }
    button {
      background-color: #d40511;
      color: #ffff00;
      width: 100%;
      text-align: center;
    }
    button:hover {
      background-color: #b0040e;
    }
    #weather-data {
      background-color: rgba(255, 255, 255, 0.9);
      color: #000000;
    }
    .highlight-red {
      background-color: #d40511;
      color: #ffffff;
      padding: 2px 4px;
      border-radius: 2px;
    }
    .highlight-orange {
      background-color: #f28c38;
      color: #ffffff;
      padding: 2px 4px;
      border-radius: 2px;
    }
    .grid-container {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 0.5rem;
      padding: 1rem;
      max-width: 1200px;
      width: 100%;
      box-sizing: border-box;
    }
    @media (max-width: 640px) {
      .grid-container {
        grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
        padding: 0.5rem;
      }
    }
  </style>
</head>
<body class="flex flex-col items-center justify-center min-h-screen p-4">
  <h1 class="text-3xl font-bold mb-6">Airport Weather Information</h1>

  <div class="grid-container">
    <button onclick="fetchWeather('EHAM', 'Amsterdam (AMS)')" class="px-4 py-2 rounded-lg font-semibold">Amsterdam (AMS)</button>
    <button onclick="fetchWeather('OBBI', 'Bahrain (BAH)')" class="px-4 py-2 rounded-lg font-semibold">Bahrain (BAH)</button>
    <button onclick="fetchWeather('LEBL', 'Barcelona (BCN)')" class="px-4 py-2 rounded-lg font-semibold">Barcelona (BCN)</button>
    <button onclick="fetchWeather('LFSB', 'Basel/Mulhouse (BSL/MLH)')" class="px-4 py-2 rounded-lg font-semibold">Basel/Mulhouse (BSL/MLH)</button>
    <button onclick="fetchWeather('LIPE', 'Bologna (BLQ)')" class="px-4 py-2 rounded-lg font-semibold">Bologna (BLQ)</button>
    <button onclick="fetchWeather('LFBD', 'Bordeaux (BOD)')" class="px-4 py-2 rounded-lg font-semibold">Bordeaux (BOD)</button>
    <button onclick="fetchWeather('EBBR', 'Brussels (BRU)')" class="px-4 py-2 rounded-lg font-semibold">Brussels (BRU)</button>
    <button onclick="fetchWeather('LHBP', 'Budapest (BUD)')" class="px-4 py-2 rounded-lg font-semibold">Budapest (BUD)</button>
    <button onclick="fetchWeather('GMMN', 'Casablanca (CMN)')" class="px-4 py-2 rounded-lg font-semibold">Casablanca (CMN)</button>
    <button onclick="fetchWeather('KCVG', 'Cincinnati (CVG)')" class="px-4 py-2 rounded-lg font-semibold">Cincinnati (CVG)</button>
    <button onclick="fetchWeather('EDDK', 'Cologne (CGN)')" class="px-4 py-2 rounded-lg font-semibold">Cologne (CGN)</button>
    <button onclick="fetchWeather('EKCH', 'Copenhagen (CPH)')" class="px-4 py-2 rounded-lg font-semibold">Copenhagen (CPH)</button>
    <button onclick="fetchWeather('EIDW', 'Dublin (DUB)')" class="px-4 py-2 rounded-lg font-semibold">Dublin (DUB)</button>
    <button onclick="fetchWeather('EGNX', 'East Midlands (EMA)')" class="px-4 py-2 rounded-lg font-semibold">East Midlands (EMA)</button>
    <button onclick="fetchWeather('VHHH', 'Hong Kong (HKG)')" class="px-4 py-2 rounded-lg font-semibold">Hong Kong (HKG)</button>
    <button onclick="fetchWeather('DNMM', 'Lagos (LOS)')" class="px-4 py-2 rounded-lg font-semibold">Lagos (LOS)</button>
    <button onclick="fetchWeather('EDDP', 'Leipzig (LEJ)')" class="px-4 py-2 rounded-lg font-semibold">Leipzig (LEJ)</button>
    <button onclick="fetchWeather('LOWL', 'Linz (LNZ)')" class="px-4 py-2 rounded-lg font-semibold">Linz (LNZ)</button>
    <button onclick="fetchWeather('EGLL', 'London Heathrow (LHR)')" class="px-4 py-2 rounded-lg font-semibold">London Heathrow (LHR)</button>
    <button onclick="fetchWeather('EGGW', 'Luton (LTN)')" class="px-4 py-2 rounded-lg font-semibold">Luton (LTN)</button>
    <button onclick="fetchWeather('LFLL', 'Lyon (LYS)')" class="px-4 py-2 rounded-lg font-semibold">Lyon (LYS)</button>
    <button onclick="fetchWeather('LEMD', 'Madrid (MAD)')" class="px-4 py-2 rounded-lg font-semibold">Madrid (MAD)</button>
    <button onclick="fetchWeather('LFML', 'Marseille (MRS)')" class="px-4 py-2 rounded-lg font-semibold">Marseille (MRS)</button>
    <button onclick="fetchWeather('LIMC', 'Milan Malpensa (MXP)')" class="px-4 py-2 rounded-lg font-semibold">Milan Malpensa (MXP)</button>
    <button onclick="fetchWeather('LFPG', 'Paris CDG (CDG)')" class="px-4 py-2 rounded-lg font-semibold">Paris CDG (CDG)</button>
    <button onclick="fetchWeather('LPPR', 'Porto (OPO)')" class="px-4 py-2 rounded-lg font-semibold">Porto (OPO)</button>
    <button onclick="fetchWeather('OERK', 'Riyadh (RUH)')" class="px-4 py-2 rounded-lg font-semibold">Riyadh (RUH)</button>
    <button onclick="fetchWeather('ZSPD', 'Shanghai (PVG)')" class="px-4 py-2 rounded-lg font-semibold">Shanghai (PVG)</button>
    <button onclick="fetchWeather('ZGSZ', 'Shenzhen (SZX)')" class="px-4 py-2 rounded-lg font-semibold">Shenzhen (SZX)</button>
    <button onclick="fetchWeather('LLBG', 'Tel Aviv (TLV)')" class="px-4 py-2 rounded-lg font-semibold">Tel Aviv (TLV)</button>
    <button onclick="fetchWeather('LFBO', 'Toulouse (TLS)')" class="px-4 py-2 rounded-lg font-semibold">Toulouse (TLS)</button>
    <button onclick="fetchWeather('LEVT', 'Vitoria (VIT)')" class="px-4 py-2 rounded-lg font-semibold">Vitoria (VIT)</button>
  </div>
  <div id="weather-data" class="w-full max-w-2xl p-6 rounded-lg shadow-lg mt-6">
    <p>Select an airport to view decoded METAR and TAF data.</p>
  </div>

  <script>
    const weatherTranslations = {
      'BR': 'mist',
      'MIBR': 'shallow mist',
      'PRBR': 'partial mist',
      'TS': 'thunderstorm',
      'FG': 'fog',
      'HZ': 'haze',
      'FU': 'smoke',
      'FZ': 'freezing',
      'VA': 'volcanic ash',
      'DU': 'widespread dust',
      'SQ': 'squall',
      'FC': 'funnel cloud',
      'PO': 'dust devils',
      'SA': 'sand',
      'CB': 'cumulonimbus',
      'TCU': 'towering cumulus',
      'WS': 'wind shear',
      '+': 'heavy',
      '-': 'light',
      'VC': 'in the vicinity',
      'FZRA': 'freezing rain',
      'NSW': 'no significant weather',
      'ALQDS': 'all quadrants',
      'FM': 'from',
      'VRB': 'variable direction',
      'BCFG': 'patches of fog',
      'MIFG': 'shallow fog',
      'PRFG': 'partial fog',
      'DRSN': 'drifting snow',
      'BLSN': 'blowing snow',
      'BECMG': 'becoming',
      'BECM': 'becoming',
      'TEMPO': 'temporary fluctuations',
      'TEMP': 'temporary fluctuations',
      'PROB30': '30% chance',
      'PROB40': '40% chance',
      'NOSIG': 'no significant change expected',
      '-RA': 'light rain',
      '+RA': 'heavy rain',
      'RA': 'rain',
      '-DZ': 'light drizzle',
      '+DZ': 'heavy drizzle',
      'DZ': 'drizzle',
      '-SN': 'light snow',
      '+SN': 'heavy snow',
      'SN': 'snow',
      '-SG': 'light snow grains',
      '+SG': 'heavy snow grains',
      'SG': 'snow grains',
      '-IC': 'light ice crystals',
      '+IC': 'heavy ice crystals',
      'IC': 'ice crystals',
      '-PL': 'light ice pellets',
      '+PL': 'heavy ice pellets',
      'PL': 'ice pellets',
      '-GR': 'light hail',
      '+GR': 'heavy hail',
      'GR': 'hail',
      '-GS': 'light small hail or snow pellets',
      '+GS': 'heavy small hail or snow pellets',
      'GS': 'small hail or snow pellets',
      '-UP': 'light unknown precipitation',
      '+UP': 'heavy unknown precipitation',
      'UP': 'unknown precipitation',
      '-FG': 'light fog',
      '+FG': 'dense fog',
      'FG': 'fog',
      '-SS': 'light sandstorm',
      '+SS': 'heavy sandstorm',
      '-DS': 'light duststorm',
      'SS': 'sandstorm',
      'DS': 'duststorm',
      '+DS': 'heavy duststorm',
      'SHRA': 'rain showers',
      '-SHRA': 'light rain showers',
      '+SHRA': 'heavy rain showers',
      '-SHSN': 'light snow showers',
      'SHSN': 'snow showers',
      '+SHSN': 'heavy snow showers',
      '-TSRA': 'thunderstorm with light rain',
      '+TSRA': 'thunderstorm with heavy rain',
      '-TSSN': 'thunderstorm with light snow',
      'TSRA': 'thunderstorm with rain',
      'TSSN': 'thunderstorm with snow',
      '+TSSN': 'thunderstorm with heavy snow',
      '-TSGR': 'thunderstorm with light hail',
      '+TSGR': 'thunderstorm with heavy hail',
      'TSGR': 'thunderstorm with hail'
    };

    const months = ['January','February','March','April','May','June','July','August','September','October','November','December'];

    function escapeRegExp(str) {
      return str.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
    }

    function decodeWeather(wxString) {
      if (!wxString) return 'none';
      // Extract PROB30, PROB40 with other weather codes, handling + and - prefixes:
      const codes = wxString.match(/PROB(?:30|40)|[+-]?[A-Z]{2,4}/g) || [];
      return codes.map(code => weatherTranslations[code] || code).join(', ');
    }

    function highlightText(text) {
      const orangeList = ['mist', 'shallow mist', 'partial mist'];
      const ignoreList = [
        'rain', 'light rain', 'heavy rain', 'rain showers',
        'light rain showers', 'heavy rain showers', 'drizzle',
        'light drizzle', 'heavy drizzle', 'light',
        'no significant weather', 'no significant change expected'
      ];
      let highlighted = text;
      Object.values(weatherTranslations).forEach(condition => {
        if (!condition) return;
        const regex = new RegExp(`\\b${escapeRegExp(condition)}\\b`, 'gi');
        if (orangeList.includes(condition.toLowerCase())) {
          highlighted = highlighted.replace(regex, `<span class="highlight-orange">${condition}</span>`);
        } else if (!ignoreList.includes(condition.toLowerCase())) {
          highlighted = highlighted.replace(regex, `<span class="highlight-red">${condition}</span>`);
        }
      });
      return highlighted;
    }

    function formatTime(isoTime) {
      if (!isoTime) return 'Unknown';
      const date = new Date(isoTime);
      const day = date.getUTCDate().toString().padStart(2, '0');
      const month = months[date.getUTCMonth()];
      const hours = date.getUTCHours().toString().padStart(2, '0');
      const minutes = date.getUTCMinutes().toString().padStart(2, '0');
      return `${day} ${month} ${hours}:${minutes} UTC`;
    }

    function isInPast(isoTime) {
      if (!isoTime) return false;
      return new Date(isoTime) < new Date();
    }

    // Decode cloud cover like before - minimal changes to your UX:
    function decodeCloudCover(cover) {
      switch (cover) {
        case 'FEW': return 'few clouds';
        case 'SCT': return 'scattered clouds';
        case 'BKN': return 'broken clouds';
        case 'OVC': return 'overcast';
        case 'NSC': return 'no significant clouds';
        case 'CAVOK': return 'ceiling and visibility ok';
        case 'CLR': return 'clear';
        case 'SKC': return 'sky clear';
        default: return cover;
      }
    }

    // Fetch and process METAR and TAF from AVWX Rest API JSON
    async function fetchWeather(icao, airportName) {
      const weatherDiv = document.getElementById('weather-data');
      weatherDiv.innerHTML = '<p>Loading...</p>';

      try {
        // METAR JSON endpoint
        const metarResponse = await fetch(`https://avwx.rest/api/metar/${icao}`, {
          headers: { 'Accept': 'application/json' }
        });
        if (!metarResponse.ok) throw new Error(`METAR fetch failed: ${metarResponse.status}`);
        const metarData = await metarResponse.json();

        // TAF JSON endpoint
        const tafResponse = await fetch(`https://avwx.rest/api/taf/${icao}`, {
          headers: { 'Accept': 'application/json' }
        });
        if (!tafResponse.ok) throw new Error(`TAF fetch failed: ${tafResponse.status}`);
        const tafData = await tafResponse.json();

        // Decode METAR
        let metarDecoded = "No METAR data available";
        if (metarData.issues && metarData.issues.nodata) {
          metarDecoded = "No METAR data available";
        } else {
          let visibilityText = metarData.visibility?.value ? `${(metarData.visibility.value * 1.60934).toFixed(1)} km` : "Unknown";

          // Highlight visibility for low ranges
          if (metarData.visibility?.value) {
            if (metarData.visibility.value * 1.60934 <= 0.56) {
              visibilityText = `<span class="highlight-red">${visibilityText}</span>`;
            } else if (metarData.visibility.value * 1.60934 <= 0.81) {
              visibilityText = `<span class="highlight-orange">${visibilityText}</span>`;
            }
          }

          // Wind decoding with highlights
          let wind = "Unknown";
          if (metarData.wind_speed) {
            const speed = parseInt(metarData.wind_speed.value);
            const dir = metarData.wind_direction && metarData.wind_direction.value !== 0 ? `${metarData.wind_direction.value}°` : 'variable direction';
            if (speed >= 26) {
              wind = `<span class="highlight-red">${speed} kt from ${dir}</span>`;
            } else if (speed >= 21) {
              wind = `<span class="highlight-orange">${speed} kt from ${dir}</span>`;
            } else {
              wind = `${speed} kt from ${dir}`;
            }
            if (metarData.wind_gust && metarData.wind_gust.value) {
              const gustSpeed = parseInt(metarData.wind_gust.value);
              if (gustSpeed >= 36) wind += `, gusts <span class="highlight-red">${gustSpeed} kt</span>`;
              else if (gustSpeed >= 25) wind += `, gusts <span class="highlight-orange">${gustSpeed} kt</span>`;
              else wind += `, gusts ${gustSpeed} kt`;
            }
          }

          // Clouds decoding
          let cloudText = "clear";
          let lowestCeiling = null;
          let hasCavok = false;
          if (Array.isArray(metarData.clouds)) {
            const cloudLayers = [];
            metarData.clouds.forEach(cloud => {
              if (cloud.code === 'CAVOK') {
                hasCavok = true;
              }
              const cover = decodeCloudCover(cloud.code);
              if ((cloud.code === 'BKN' || cloud.code === 'OVC') && cloud.base_ft) {
                if (!lowestCeiling || cloud.base_ft < lowestCeiling) lowestCeiling = cloud.base_ft;
              }
              cloudLayers.push(cover + (cloud.base_ft ? ` at ${cloud.base_ft} ft` : ''));
            });
            if (hasCavok) {
              cloudText = 'ceiling and visibility ok';
            } else if (cloudLayers.length) {
              cloudText = cloudLayers.join(', ');
              if (lowestCeiling) {
                if (lowestCeiling <= 200) cloudText = `<span class="highlight-red">${cloudText}</span>`;
                else if (lowestCeiling <= 399) cloudText = `<span class="highlight-orange">${cloudText}</span>`;
              }
            }
          }

          // Weather decoding + highlight
          const decodedWx = decodeWeather(metarData.raw);
          const highlightedWx = highlightText(decodedWx);

          // Observation time
          const observationTime = metarData.time ? formatTime(metarData.time.dt) : 'Unknown';

          const temp = metarData.temperature ? metarData.temperature.value : 'Unknown';
          const dewpoint = metarData.dewpoint ? metarData.dewpoint.value : 'Unknown';
          const pressure = metarData.altimeter ? metarData.altimeter.value.toFixed(0) : 'Unknown';

          metarDecoded = `
            Observation time: ${observationTime}<br>
            Wind: ${wind}<br>
            Visibility: ${visibilityText}<br>
            Clouds: ${cloudText}<br>
            ${highlightedWx && highlightedWx !== 'none' ? `Weather: ${highlightedWx}<br>` : ''}
            Temperature & Dewpoint: ${temp}°C / ${dewpoint}°C<br>
            Pressure: ${pressure} hPa
          `;
        }

        // Decode TAF
        let tafDecoded = "No TAF data available";
        if (!tafData.forecast || !tafData.forecast.length) {
          tafDecoded = "No TAF data available";
        } else {
          const forecastItems = tafData.forecast.filter(fc => !isInPast(fc.time_end || fc.time_from));
          if (forecastItems.length === 0) {
            tafDecoded = "No upcoming TAF forecast available";
          } else {
            const sections = forecastItems.map(fc => {
              const from = formatTime(fc.time_from);
              const to = formatTime(fc.time_end);
              // Wind
              let wind = "Unknown";
              if (fc.wind_speed) {
                const speed = parseInt(fc.wind_speed.value);
                const dir = fc.wind_direction && fc.wind_direction.value !== 0 ? `${fc.wind_direction.value}°` : 'variable direction';
                if (speed >= 26) {
                  wind = `<span class="highlight-red">${speed} kt from ${dir}</span>`;
                } else if (speed >= 21) {
                  wind = `<span class="highlight-orange">${speed} kt from ${dir}</span>`;
                } else {
                  wind = `${speed} kt from ${dir}`;
                }
                if (fc.wind_gust && fc.wind_gust.value) {
                  const gustSpeed = parseInt(fc.wind_gust.value);
                  if (gustSpeed >= 36) wind += `, gusts <span class="highlight-red">${gustSpeed} kt</span>`;
                  else if (gustSpeed >= 25) wind += `, gusts <span class="highlight-orange">${gustSpeed} kt</span>`;
                  else wind += `, gusts ${gustSpeed} kt`;
                }
              }

              // Visibility
              let visibilityText = fc.visibility && fc.visibility.value ? `${(fc.visibility.value * 1.60934).toFixed(1)} km` : "Unknown";
              if (fc.visibility && fc.visibility.value) {
                if (fc.visibility.value * 1.60934 <= 0.56) {
                  visibilityText = `<span class="highlight-red">${visibilityText}</span>`;
                } else if (fc.visibility.value * 1.60934 <= 0.81) {
                  visibilityText = `<span class="highlight-orange">${visibilityText}</span>`;
                }
              }

              // Clouds decode
              let cloudText = "clear";
              let lowestCeiling = null;
              let hasCavok = false;
              if (Array.isArray(fc.clouds)) {
                const cloudLayers = [];
                fc.clouds.forEach(cloud => {
                  if (cloud.code === 'CAVOK') hasCavok = true;
                  const cover = decodeCloudCover(cloud.code);
                  if ((cloud.code === 'BKN' || cloud.code === 'OVC') && cloud.base_ft) {
                    if (!lowestCeiling || cloud.base_ft < lowestCeiling) lowestCeiling = cloud.base_ft;
                  }
                  cloudLayers.push(cover + (cloud.base_ft ? ` at ${cloud.base_ft} ft` : ''));
                });
                if (hasCavok) {
                  cloudText = 'ceiling and visibility ok';
                } else if (cloudLayers.length) {
                  cloudText = cloudLayers.join(', ');
                  if (lowestCeiling) {
                    if (lowestCeiling <= 200) cloudText = `<span class="highlight-red">${cloudText}</span>`;
                    else if (lowestCeiling <= 399) cloudText = `<span class="highlight-orange">${cloudText}</span>`;
                  }
                }
              }

              // Weather decode and highlight
              let wxString = fc.raw || "";
              if (fc.change_indicator) {
                wxString = fc.change_indicator + " " + wxString;
              }
              const decodedWx = decodeWeather(wxString.trim());
              const highlightedWx = highlightText(decodedWx);

              return `
                ${from} to ${to}:<br>
                &nbsp;&nbsp;Wind: ${wind}<br>
                &nbsp;&nbsp;Visibility: ${visibilityText}<br>
                &nbsp;&nbsp;Clouds: ${cloudText}<br>
                ${highlightedWx && highlightedWx !== 'none' ? `&nbsp;&nbsp;Weather: ${highlightedWx}<br>` : ''}
              `;
            });
            tafDecoded = sections.join('<br><br>');
          }
        }

        weatherDiv.innerHTML = `
          <h2 class="text-xl font-bold mb-2 text-[#D40511]">${airportName} Weather Data</h2>
          <h3 class="font-semibold">Decoded METAR</h3>
          <p>${metarDecoded}</p>
          <br>
          <h3 class="font-semibold mt-4">Decoded TAF</h3>
          <p>${tafDecoded}</p>
        `;
      }
      catch (error) {
        weatherDiv.innerHTML = `<p>Error fetching data: ${error.message}</p>`;
      }
    }
  </script>
</body>
</html>
