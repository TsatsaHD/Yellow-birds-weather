<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Airport Weather</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body {
      background-color: #FFC107; /* DHL Yellow */
      color: #D40511; /* DHL Red for headings and buttons */
    }
    button {
      background-color: #D40511;
      color: #FFC107;
      width: 100%;
      text-align: center;
    }
    button:hover {
      background-color: #b0040e;
    }
    #weather-data {
      background-color: rgba(255, 255, 255, 0.9);
      color: #000000; /* Black text for decoded METAR and TAF */
    }
    .highlight-red {
      background-color: #D40511;
      color: #FFFFFF;
      padding: 2px 4px;
      border-radius: 2px;
    }
    .highlight-orange {
      background-color: #F28C38;
      color: #FFFFFF;
      padding: 2px 4px;
      border-radius: 2px;
    }
    .grid-container {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 0.5rem; /* Consistent spacing between buttons */
      padding: 1rem; /* Consistent padding around the grid */
      max-width: 1200px; /* Max width for larger screens */
      width: 100%;
      box-sizing: border-box;
    }
    @media (max-width: 640px) {
      .grid-container {
        grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
        gap: 0.5rem;
        padding: 0.5rem;
      }
    }
  </style>
</head>
<body class="flex flex-col items-center justify-center min-h-screen p-4">
  <h1 class="text-3xl font-bold mb-6">Airport Weather Information</h1>
  <div class="grid-container">
    <button onclick="fetchWeather('EHAM', 'Amsterdam (AMS)')" class="px-4 py-2 rounded-lg font-semibold">Amsterdam (AMS)</button>
    <button onclick="fetchWeather('OBBI', 'Bahrain (BAH)')" class="px-4 py-2 rounded-lg font-semibold">Bahrain (BAH)</button>
    <button onclick="fetchWeather('LEBL', 'Barcelona (BCN)')" class="px-4 py-2 rounded-lg font-semibold">Barcelona (BCN)</button>
    <button onclick="fetchWeather('LFSB', 'Basel/Mulhouse (BSL/MLH)')" class="px-4 py-2 rounded-lg font-semibold">Basel/Mulhouse (BSL/MLH)</button>
    <button onclick="fetchWeather('LIPE', 'Bologna (BLQ)')" class="px-4 py-2 rounded-lg font-semibold">Bologna (BLQ)</button>
    <button onclick="fetchWeather('LFBD', 'Bordeaux (BOD)')" class="px-4 py-2 rounded-lg font-semibold">Bordeaux (BOD)</button>
    <button onclick="fetchWeather('EBBR', 'Brussels (BRU)')" class="px-4 py-2 rounded-lg font-semibold">Brussels (BRU)</button>
    <button onclick="fetchWeather('LHBP', 'Budapest (BUD)')" class="px-4 py-2 rounded-lg font-semibold">Budapest (BUD)</button>
    <button onclick="fetchWeather('GMMN', 'Casablanca (CMN)')" class="px-4 py-2 rounded-lg font-semibold">Casablanca (CMN)</button>
    <button onclick="fetchWeather('KCVG', 'Cincinnati (CVG)')" class="px-4 py-2 rounded-lg font-semibold">Cincinnati (CVG)</button>
    <button onclick="fetchWeather('EDDK', 'Cologne (CGN)')" class="px-4 py-2 rounded-lg font-semibold">Cologne (CGN)</button>
    <button onclick="fetchWeather('EKCH', 'Copenhagen (CPH)')" class="px-4 py-2 rounded-lg font-semibold">Copenhagen (CPH)</button>
    <button onclick="fetchWeather('EIDW', 'Dublin (DUB)')" class="px-4 py-2 rounded-lg font-semibold">Dublin (DUB)</button>
    <button onclick="fetchWeather('EGNX', 'East Midlands (EMA)')" class="px-4 py-2 rounded-lg font-semibold">East Midlands (EMA)</button>
    <button onclick="fetchWeather('VHHH', 'Hong Kong (HKG)')" class="px-4 py-2 rounded-lg font-semibold">Hong Kong (HKG)</button>
    <button onclick="fetchWeather('DNMM', 'Lagos (LOS)')" class="px-4 py-2 rounded-lg font-semibold">Lagos (LOS)</button>
    <button onclick="fetchWeather('EDDP', 'Leipzig (LEJ)')" class="px-4 py-2 rounded-lg font-semibold">Leipzig (LEJ)</button>
    <button onclick="fetchWeather('LOWL', 'Linz (LNZ)')" class="px-4 py-2 rounded-lg font-semibold">Linz (LNZ)</button>
    <button onclick="fetchWeather('EGLL', 'London Heathrow (LHR)')" class="px-4 py-2 rounded-lg font-semibold">London Heathrow (LHR)</button>
    <button onclick="fetchWeather('EGGW', 'Luton (LTN)')" class="px-4 py-2 rounded-lg font-semibold">Luton (LTN)</button>
    <button onclick="fetchWeather('LFLL', 'Lyon (LYS)')" class="px-4 py-2 rounded-lg font-semibold">Lyon (LYS)</button>
    <button onclick="fetchWeather('LEMD', 'Madrid (MAD)')" class="px-4 py-2 rounded-lg font-semibold">Madrid (MAD)</button>
    <button onclick="fetchWeather('LFML', 'Marseille (MRS)')" class="px-4 py-2 rounded-lg font-semibold">Marseille (MRS)</button>
    <button onclick="fetchWeather('LIMC', 'Milan Malpensa (MXP)')" class="px-4 py-2 rounded-lg font-semibold">Milan Malpensa (MXP)</button>
    <button onclick="fetchWeather('LFPG', 'Paris CDG (CDG)')" class="px-4 py-2 rounded-lg font-semibold">Paris CDG (CDG)</button>
    <button onclick="fetchWeather('LPPR', 'Porto (OPO)')" class="px-4 py-2 rounded-lg font-semibold">Porto (OPO)</button>
    <button onclick="fetchWeather('OERK', 'Riyadh (RUH)')" class="px-4 py-2 rounded-lg font-semibold">Riyadh (RUH)</button>
    <button onclick="fetchWeather('ZSPD', 'Shanghai (PVG)')" class="px-4 py-2 rounded-lg font-semibold">Shanghai (PVG)</button>
    <button onclick="fetchWeather('ZGSZ', 'Shenzhen (SZX)')" class="px-4 py-2 rounded-lg font-semibold">Shenzhen (SZX)</button>
    <button onclick="fetchWeather('LLBG', 'Tel Aviv (TLV)')" class="px-4 py-2 rounded-lg font-semibold">Tel Aviv (TLV)</button>
    <button onclick="fetchWeather('LFBO', 'Toulouse (TLS)')" class="px-4 py-2 rounded-lg font-semibold">Toulouse (TLS)</button>
    <button onclick="fetchWeather('LEVT', 'Vitoria (VIT)')" class="px-4 py-2 rounded-lg font-semibold">Vitoria (VIT)</button>
  </div>
  <div id="weather-data" class="w-full max-w-2xl p-6 rounded-lg shadow-lg mt-6">
    <p>Select an airport to view decoded METAR and TAF data.</p>
  </div>

  <script>
    const severeWeather = ['TSRA', 'TS', 'thunderstorm', 'SN', 'snow', 'FG', 'fog', 'GR', 'hail', 'GS', 'small hail', 'snow pellets', 'BR', 'mist', 'HZ', 'haze', 'FU', 'smoke', 'DS', 'duststorm', 'SS', 'sandstorm', 'severe wind', 'FZ', 'freezing', 'VA', 'volcanic ash', 'DU', 'widespread dust', 'SQ', 'squall', 'FC', 'funnel cloud', 'PO', 'dust devils', 'ice crystals', 'PL', 'ice pellets', 'SG', 'snow grains', 'SA', 'sand', 'CB', 'cumulonimbus', 'TCU', 'towering cumulus', 'WS', 'wind shear'];

    const months = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];

    function highlightText(text, conditions, className) {
      let highlighted = text;
      conditions.forEach(condition => {
        const regex = new RegExp(`\\b${condition}\\b`, 'gi');
        highlighted = highlighted.replace(regex, `<span class="${className}">${condition}</span>`);
      });
      return highlighted;
    }

    function parseCloudHeight(cloud) {
      if (!cloud) return null;
      const heightMatch = cloud.match(/(\d+)/);
      return heightMatch ? parseInt(heightMatch[1]) : null;
    }

    function formatTime(isoTime) {
      if (!isoTime) return 'Unknown';
      const date = new Date(isoTime);
      const day = date.getUTCDate().toString().padStart(2, '0');
      const month = months[date.getUTCMonth()];
      const year = date.getUTCFullYear();
      const hours = date.getUTCHours().toString().padStart(2, '0');
      const minutes = date.getUTCMinutes().toString().padStart(2, '0');
      return `${day} ${month} ${year} ${hours}:${minutes} UTC`;
    }

    async function fetchWeather(icao, airportName) {
      const weatherDiv = document.getElementById('weather-data');
      weatherDiv.innerHTML = '<p>Loading...</p>';

      try {
        // Fetch METAR
        const metarResponse = await fetch(`https://aviationweather.gov/api/data/metar?ids=${icao}&format=xml`);
        const metarText = await metarResponse.text();
        const metarParser = new DOMParser();
        const metarXml = metarParser.parseFromString(metarText, 'text/xml');
        const metarNode = metarXml.querySelector('METAR');
        let metarDecoded = 'No METAR data available';
        if (metarNode) {
          const rawText = metarNode.querySelector('raw_text')?.textContent || '';
          const observationTime = formatTime(metarNode.querySelector('observation_time')?.textContent);
          let wind = metarNode.querySelector('wind_speed')?.textContent || 'Unknown';
          const windDir = metarNode.querySelector('wind_dir_degrees')?.textContent || '';
          const windGust = metarNode.querySelector('wind_gust_kt')?.textContent || null;
          let visibility = metarNode.querySelector('visibility_statute_mi')?.textContent || '10';
          const visibilityKm = parseFloat(visibility) * 1.60934;
          const temp = metarNode.querySelector('temp_c')?.textContent || 'Unknown';
          const dewpoint = metarNode.querySelector('dewpoint_c')?.textContent || 'Unknown';
          const pressureInHg = metarNode.querySelector('altim_in_hg')?.textContent || 'Unknown';
          const pressure = pressureInHg !== 'Unknown' ? (parseFloat(pressureInHg) * 33.8639).toFixed(0) : 'Unknown';
          const clouds = metarNode.querySelectorAll('sky_condition');
          let cloudText = 'Clear';
          let lowestCeiling = null;
          clouds.forEach(cloud => {
            const cover = cloud.getAttribute('sky_cover');
            const base = parseCloudHeight(cloud.getAttribute('cloud_base_ft_agl'));
            if (base && (!lowestCeiling || base < lowestCeiling)) lowestCeiling = base;
            cloudText = cover + (base ? ` at ${base} ft` : '');
          });
          const wxString = metarNode.querySelector('wx_string')?.textContent || '';

          // Apply highlighting
          if (visibilityKm <= 0.56) visibility = `<span class="highlight-red">${visibilityKm.toFixed(1)} km</span>`;
          else if (visibilityKm <= 0.81) visibility = `<span class="highlight-orange">${visibilityKm.toFixed(1)} km</span>`;
          else visibility = `${visibilityKm.toFixed(1)} km`;
          
          if (wind !== 'Unknown') {
            const windSpeed = parseInt(wind);
            if (windSpeed >= 26) wind = `<span class="highlight-red">${windSpeed} kt from ${windDir}°</span>`;
            else if (windSpeed >= 21) wind = `<span class="highlight-orange">${windSpeed} kt from ${windDir}°</span>`;
            else wind = `${windSpeed} kt from ${windDir}°`;
          }
          
          if (windGust) {
            const gustSpeed = parseInt(windGust);
            if (gustSpeed >= 36) wind += `, gusts <span class="highlight-red">${gustSpeed} kt</span>`;
            else if (gustSpeed >= 25) wind += `, gusts <span class="highlight-orange">${gustSpeed} kt</span>`;
          }
          
          if (lowestCeiling) {
            if (lowestCeiling <= 200) cloudText = `<span class="highlight-red">${cloudText}</span>`;
            else if (lowestCeiling <= 399) cloudText = `<span class="highlight-orange">${cloudText}</span>`;
          }
          
          const highlightedWx = highlightText(wxString, severeWeather, 'highlight-red');

          metarDecoded = `
            Observation time: ${observationTime}<br>
            Wind: ${wind}<br>
            Visibility: ${visibility}<br>
            Clouds: ${cloudText}<br>
            Weather: ${highlightedWx || 'None'}<br>
            Temperature/Dewpoint: ${temp}°C / ${dewpoint}°C<br>
            Pressure: ${pressure} hPa
          `;
        }

        // Fetch TAF
        const tafResponse = await fetch(`https://aviationweather.gov/api/data/taf?ids=${icao}&format=xml`);
        const tafText = await tafResponse.text();
        const tafParser = new DOMParser();
        const tafXml = tafParser.parseFromString(tafText, 'text/xml');
        const tafNode = tafXml.querySelector('TAF');
        let tafDecoded = 'No TAF data available';
        if (tafNode) {
          const validTime = formatTime(tafNode.querySelector('valid_time')?.textContent);
          const forecast = [];
          const fcstGroups = tafNode.querySelectorAll('forecast');
          fcstGroups.forEach(fc => {
            const timeFrom = formatTime(fc.querySelector('fcst_time_from')?.textContent);
            const timeTo = formatTime(fc.querySelector('fcst_time_to')?.textContent);
            let wind = fc.querySelector('wind_speed_kt')?.textContent || 'Unknown';
            const windDir = fc.querySelector('wind_dir_degrees')?.textContent || '';
            const windGust = fc.querySelector('wind_gust_kt')?.textContent || null;
            let visibility = fc.querySelector('visibility_statute_mi')?.textContent || '10';
            const visibilityKm = parseFloat(visibility) * 1.60934;
            const clouds = fc.querySelectorAll('sky_condition');
            let cloudText = 'Clear';
            let lowestCeiling = null;
            clouds.forEach(cloud => {
              const cover = cloud.getAttribute('sky_cover');
              const base = parseCloudHeight(cloud.getAttribute('cloud_base_ft_agl'));
              if (base && (!lowestCeiling || base < lowestCeiling)) lowestCeiling = base;
              cloudText = cover + (base ? ` at ${base} ft` : '');
            });
            const wxString = fc.querySelector('wx_string')?.textContent || '';
            const change = fc.querySelector('change_indicator')?.textContent || '';

            // Apply highlighting
            if (visibilityKm <= 0.56) visibility = `<span class="highlight-red">${visibilityKm.toFixed(1)} km</span>`;
            else if (visibilityKm <= 0.81) visibility = `<span class="highlight-orange">${visibilityKm.toFixed(1)} km</span>`;
            else visibility = `${visibilityKm.toFixed(1)} km`;
            
            if (wind !== 'Unknown') {
              const windSpeed = parseInt(wind);
              if (windSpeed >= 26) wind = `<span class="highlight-red">${windSpeed} kt from ${windDir}°</span>`;
              else if (windSpeed >= 21) wind = `<span class="highlight-orange">${windSpeed} kt from ${windDir}°</span>`;
              else wind = `${windSpeed} kt from ${windDir}°`;
            }
            
            if (windGust) {
              const gustSpeed = parseInt(windGust);
              if (gustSpeed >= 36) wind += `, gusts <span class="highlight-red">${gustSpeed} kt</span>`;
              else if (gustSpeed >= 25) wind += `, gusts <span class="highlight-orange">${gustSpeed} kt</span>`;
            }
            
            if (lowestCeiling) {
              if (lowestCeiling <= 200) cloudText = `<span class="highlight-red">${cloudText}</span>`;
              else if (lowestCeiling <= 399) cloudText = `<span class="highlight-orange">${cloudText}</span>`;
            }
            
            const highlightedWx = highlightText(wxString, severeWeather, 'highlight-red');

            forecast.push(`
              ${change} ${timeFrom} to ${timeTo}:<br>
              &nbsp;&nbsp;Wind: ${wind}<br>
              &nbsp;&nbsp;Visibility: ${visibility}<br>
              &nbsp;&nbsp;Clouds: ${cloudText}<br>
              &nbsp;&nbsp;Weather: ${highlightedWx || 'None'}
            `);
          });
          tafDecoded = `
            Valid: ${validTime}<br>
            ${forecast.join('<br><br>')}
          `;
        }

        // Display data
        weatherDiv.innerHTML = `
          <h2 class="text-xl font-bold mb-2 text-[#D40511]">${airportName} Weather Data</h2>
          <h3 class="font-semibold">Decoded METAR</h3>
          <p>${metarDecoded}</p>
          <h3 class="font-semibold mt-4">Decoded TAF</h3>
          <p>${tafDecoded}</p>
        `;
      } catch (error) {
        weatherDiv.innerHTML = `<p>Error fetching data: ${error.message}</p>`;
      }
    }
  </script>
</body>
</html>