<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Airport Weather</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body {
      background-color: #ffc107;
      color: #d40511;
    }
    button {
      background-color: #d40511;
      color: #ffff00;
      width: 100%;
      text-align: center;
    }
    button:hover {
      background-color: #b0040e;
    }
    #weather-data {
      background-color: rgba(255, 255, 255, 0.9);
      color: #000000;
    }
    .highlight-red {
      background-color: #d40511;
      color: #ffffff;
      padding: 2px 4px;
      border-radius: 2px;
    }
    .highlight-orange {
      background-color: #f28c38;
      color: #ffffff;
      padding: 2px 4px;
      border-radius: 2px;
    }
    .grid-container {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 0.5rem;
      padding: 1rem;
      max-width: 1200px;
      width: 100%;
      box-sizing: border-box;
    }
    @media (max-width: 640px) {
      .grid-container {
        grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
        padding: 0.5rem;
      }
    }
  </style>
</head>
<body class="flex flex-col items-center justify-center min-h-screen p-4">
  <h1 class="text-3xl font-bold mb-6">Airport Weather Information</h1>

  <div class="grid-container">
    <button onclick="fetchWeather('EHAM', 'Amsterdam (AMS)')" class="px-4 py-2 rounded-lg font-semibold">Amsterdam (AMS)</button>
    <button onclick="fetchWeather('OBBI', 'Bahrain (BAH)')" class="px-4 py-2 rounded-lg font-semibold">Bahrain (BAH)</button>
    <button onclick="fetchWeather('LEBL', 'Barcelona (BCN)')" class="px-4 py-2 rounded-lg font-semibold">Barcelona (BCN)</button>
    <button onclick="fetchWeather('LFSB', 'Basel/Mulhouse (BSL/MLH)')" class="px-4 py-2 rounded-lg font-semibold">Basel/Mulhouse (BSL/MLH)</button>
    <button onclick="fetchWeather('LIPE', 'Bologna (BLQ)')" class="px-4 py-2 rounded-lg font-semibold">Bologna (BLQ)</button>
    <button onclick="fetchWeather('LFBD', 'Bordeaux (BOD)')" class="px-4 py-2 rounded-lg font-semibold">Bordeaux (BOD)</button>
    <button onclick="fetchWeather('EBBR', 'Brussels (BRU)')" class="px-4 py-2 rounded-lg font-semibold">Brussels (BRU)</button>
    <button onclick="fetchWeather('LHBP', 'Budapest (BUD)')" class="px-4 py-2 rounded-lg font-semibold">Budapest (BUD)</button>
    <button onclick="fetchWeather('GMMN', 'Casablanca (CMN)')" class="px-4 py-2 rounded-lg font-semibold">Casablanca (CMN)</button>
    <button onclick="fetchWeather('KCVG', 'Cincinnati (CVG)')" class="px-4 py-2 rounded-lg font-semibold">Cincinnati (CVG)</button>
    <button onclick="fetchWeather('EDDK', 'Cologne (CGN)')" class="px-4 py-2 rounded-lg font-semibold">Cologne (CGN)</button>
    <button onclick="fetchWeather('EKCH', 'Copenhagen (CPH)')" class="px-4 py-2 rounded-lg font-semibold">Copenhagen (CPH)</button>
    <button onclick="fetchWeather('EIDW', 'Dublin (DUB)')" class="px-4 py-2 rounded-lg font-semibold">Dublin (DUB)</button>
    <button onclick="fetchWeather('EGNX', 'East Midlands (EMA)')" class="px-4 py-2 rounded-lg font-semibold">East Midlands (EMA)</button>
    <button onclick="fetchWeather('VHHH', 'Hong Kong (HKG)')" class="px-4 py-2 rounded-lg font-semibold">Hong Kong (HKG)</button>
    <button onclick="fetchWeather('DNMM', 'Lagos (LOS)')" class="px-4 py-2 rounded-lg font-semibold">Lagos (LOS)</button>
    <button onclick="fetchWeather('EDDP', 'Leipzig (LEJ)')" class="px-4 py-2 rounded-lg font-semibold">Leipzig (LEJ)</button>
    <button onclick="fetchWeather('LOWL', 'Linz (LNZ)')" class="px-4 py-2 rounded-lg font-semibold">Linz (LNZ)</button>
    <button onclick="fetchWeather('EGLL', 'London Heathrow (LHR)')" class="px-4 py-2 rounded-lg font-semibold">London Heathrow (LHR)</button>
    <button onclick="fetchWeather('EGGW', 'Luton (LTN)')" class="px-4 py-2 rounded-lg font-semibold">Luton (LTN)</button>
    <button onclick="fetchWeather('LFLL', 'Lyon (LYS)')" class="px-4 py-2 rounded-lg font-semibold">Lyon (LYS)</button>
    <button onclick="fetchWeather('LEMD', 'Madrid (MAD)')" class="px-4 py-2 rounded-lg font-semibold">Madrid (MAD)</button>
    <button onclick="fetchWeather('LFML', 'Marseille (MRS)')" class="px-4 py-2 rounded-lg font-semibold">Marseille (MRS)</button>
    <button onclick="fetchWeather('LIMC', 'Milan Malpensa (MXP)')" class="px-4 py-2 rounded-lg font-semibold">Milan Malpensa (MXP)</button>
    <button onclick="fetchWeather('LFPG', 'Paris CDG (CDG)')" class="px-4 py-2 rounded-lg font-semibold">Paris CDG (CDG)</button>
    <button onclick="fetchWeather('LPPR', 'Porto (OPO)')" class="px-4 py-2 rounded-lg font-semibold">Porto (OPO)</button>
    <button onclick="fetchWeather('OERK', 'Riyadh (RUH)')" class="px-4 py-2 rounded-lg font-semibold">Riyadh (RUH)</button>
    <button onclick="fetchWeather('ZSPD', 'Shanghai (PVG)')" class="px-4 py-2 rounded-lg font-semibold">Shanghai (PVG)</button>
    <button onclick="fetchWeather('ZGSZ', 'Shenzhen (SZX)')" class="px-4 py-2 rounded-lg font-semibold">Shenzhen (SZX)</button>
    <button onclick="fetchWeather('LLBG', 'Tel Aviv (TLV)')" class="px-4 py-2 rounded-lg font-semibold">Tel Aviv (TLV)</button>
    <button onclick="fetchWeather('LFBO', 'Toulouse (TLS)')" class="px-4 py-2 rounded-lg font-semibold">Toulouse (TLS)</button>
    <button onclick="fetchWeather('LEVT', 'Vitoria (VIT)')" class="px-4 py-2 rounded-lg font-semibold">Vitoria (VIT)</button>
  </div>
  <div id="weather-data" class="w-full max-w-2xl p-6 rounded-lg shadow-lg mt-6">
    <p>Select an airport to view decoded METAR and TAF data.</p>
  </div>

  <script>
    const weatherTranslations = {
      'BR': 'mist',
      'TS': 'thunderstorm',
      'FG': 'fog',
      'HZ': 'haze',
      'FU': 'smoke',
      'FZ': 'freezing',
      'VA': 'volcanic ash',
      'DU': 'widespread dust',
      'SQ': 'squall',
      'FC': 'funnel cloud',
      'PO': 'dust devils',
      'SA': 'sand',
      'CB': 'cumulonimbus',
      'TCU': 'towering cumulus',
      'WS': 'wind shear',
      '+': 'heavy ',
      '-': 'light ',
      'VC': 'in the vicinity ',
      'FZRA': 'freezing rain',
      'NSW': 'no significant weather',
      'ALQDS': 'all quadrants',
      'FM': 'from',
      'VRB': 'variable direction',
      'BCFG': 'patches of fog',
      'MIFG': 'shallow fog',
      'PRFG': 'partial fog',
      'DRSN': 'drifting snow',
      'BLSN': 'blowing snow',
      'MIBR': 'shallow mist',
      'PRBR': 'partial mist',
      'DRDU': 'drifting dust',
      'DRSA': 'drifting sand',
      'BLDU': 'blowing dust',
      'BLSA': 'blowing sand',
      'BECMG': 'becoming',
      'BECM': 'becoming',
      'TEMPO': 'temporary fluctuations',
      'TEMP': 'temporary fluctuations',
      'PROB30': '30% chance',
      'PROB40': '40% chance',
      'NOSIG': 'no significant change expected',
      '-RA': 'light rain',
      '+RA': 'heavy rain',
      'RA': 'rain',
      '-DZ': 'light drizzle',
      '+DZ': 'heavy drizzle',
      'DZ': 'drizzle',
      '-SN': 'light snow',
      '+SN': 'heavy snow',
      'SN': 'snow',
      '-SG': 'light snow grains',
      '+SG': 'heavy snow grains',
      'SG': 'snow grains',
      '-IC': 'light ice crystals',
      '+IC': 'heavy ice crystals',
      'IC': 'ice crystals',
      '-PL': 'light ice pellets',
      '+PL': 'heavy ice pellets',
      'PL': 'ice pellets',
      '-GR': 'light hail',
      '+GR': 'heavy hail',
      'GR': 'hail',
      '-GS': 'light small hail or snow pellets',
      '+GS': 'heavy small hail or snow pellets',
      'GS': 'small hail or snow pellets',
      '-UP': 'light unknown precipitation',
      '+UP': 'heavy unknown precipitation',
      'UP': 'unknown precipitation',
      '-FG': 'light fog',
      '+FG': 'dense fog',
      'FG': 'fog',
      '-SS': 'light sandstorm',
      '+SS': 'heavy sandstorm',
      '-DS': 'light duststorm',
      'SS': 'sandstorm',
      'DS': 'duststorm',
      '+DS': 'heavy duststorm',
      'SHRA': 'rain showers',
      '-SHRA': 'light rain showers',
      '+SHRA': 'heavy rain showers',
      '-SHSN': 'light snow showers',
      'SHSN': 'snow showers',
      '+SHSN': 'heavy snow showers',
      '-TSRA': 'thunderstorm with light rain',
      '+TSRA': 'thunderstorm with heavy rain',
      '-TSSN': 'thunderstorm with light snow',
      'TSRA': 'thunderstorm with rain',
      'TSSN': 'thunderstorm with snow',
      '+TSSN': 'thunderstorm with heavy snow',
      '-TSGR': 'thunderstorm with light hail',
      '+TSGR': 'thunderstorm with heavy hail',
      'TSGR': 'thunderstorm with hail',
    };

    const months = ['january', 'february', 'march', 'april', 'may', 'june', 'july', 'august', 'september', 'october', 'november', 'december'];

    function escapeRegExp(str) {
      return str.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
    }

    function decodeWeather(wxString) {
      if (!wxString) return 'none';
      const codes = wxString.match(/PROB(?:30|40)|[+-]?[A-Z]{2,4}/g) || [];
      return codes.map(code => weatherTranslations[code] || code).join(', ');
    }

    function highlightText(text) {
      const orangeList = ['mist', 'shallow mist', 'partial mist']; 
      const ignoreList = [
        'rain',
        'light rain',
        'heavy rain',
        'rain showers',
        'light rain showers',
        'heavy rain showers',
        'drizzle',
        'light drizzle',
        'heavy drizzle',
        'light ',
        'no significant weather',
        'no significant change expected'
      ];

      let highlighted = text;

      Object.values(weatherTranslations).forEach(condition => {
        if (!condition) return;
        const regex = new RegExp(`\\b${escapeRegExp(condition)}\\b`, 'gi');

        if (orangeList.includes(condition.toLowerCase())) {
          highlighted = highlighted.replace(regex, `<span class="highlight-orange">${condition}</span>`);
        } else if (!ignoreList.includes(condition.toLowerCase())) {
          highlighted = highlighted.replace(regex, `<span class="highlight-red">${condition}</span>`);
        }
      });

      return highlighted;
    }

    function decodeCloudCover(cover) {
      switch (cover) {
        case 'FEW': return 'few clouds';
        case 'SCT': return 'scattered clouds';
        case 'BKN': return 'broken clouds';
        case 'OVC': return 'overcast';
        case 'NSC': return 'no significant clouds';
        case 'CAVOK': return 'ceiling and visibility ok';
        case 'CLR': return 'clear';
        case 'SKC': return 'sky clear';
        default: return cover;
      }
    }

    function formatTime(isoTime) {
      if (!isoTime) return 'Unknown';
      const date = new Date(isoTime);
      const day = date.getUTCDate().toString().padStart(2, '0');
      const month = months[date.getUTCMonth()];
      const hours = date.getUTCHours().toString().padStart(2, '0');
      const minutes = date.getUTCMinutes().toString().padStart(2, '0');
      return `${day} ${month} ${hours}:${minutes} UTC`;
    }

    function isInPast(isoTime) {
      if (!isoTime) return false;
      const currentTime = new Date();
      const time = new Date(isoTime);
      return time < currentTime;
    }

    async function fetchWeather(icao, airportName) {
      const weatherDiv = document.getElementById('weather-data');
      weatherDiv.innerHTML = '<p>Loading...</p>';

      try {
        // Fetch METAR using 2025 AviationWeather API JSON endpoint
        const metarResponse = await fetch(`https://aviationweather.gov/api/data/metar?ids=${icao}&format=json`, {
          headers: {
            'User-Agent': 'AirportWeatherApp/1.0'
          }
        });
        
        let metarDecoded = 'No METAR data available';
        if (metarResponse.ok && metarResponse.status !== 204) {
          const metarData = await metarResponse.json();
          if (metarData && metarData.length > 0) {
            const metar = metarData[0];
            const observationTime = formatTime(metar.reportTime);
            const wind = metar.wspd !== null && metar.wspd !== undefined ? `${metar.wspd}` : 'calm';
            const windDir = metar.wdir !== null && metar.wdir !== undefined ? `${metar.wdir}°` : 'variable direction';
            const windGust = metar.wgst ? ` gusting ${metar.wgst} knots` : '';
            const visibility = metar.visib !== null ? metar.visib : 10;
            const visibilityKm = (visibility * 1.60934).toFixed(1);
            const temp = metar.temp !== null && metar.temp !== undefined ? `${metar.temp}` : 'Unknown';
            const dewpoint = metar.dewp !== null && metar.dewp !== undefined ? `${metar.dewp}` : 'Unknown';
            const pressureInHg = metar.altim !== null && metar.altim !== undefined ? metar.altim.toFixed(2) : 'Unknown';
            const pressureHpa = metar.altim !== null ? (metar.altim * 33.8639).toFixed(0) : 'Unknown';
            const wxString = metar.wxString || '';
            const weather = decodeWeather(wxString) || 'none';

            let clouds = 'clear skies';
            if (metar.clouds && metar.clouds.length > 0) {
              clouds = metar.clouds.map(cloud => {
                const cover = decodeCloudCover(cloud.cover);
                const base = cloud.base ? ` at ${cloud.base} feet` : '';
                return `${cover}${base}`;
              }).join(', ');
            }

            metarDecoded = `<strong>${airportName}</strong><br>
              Observation time: ${observationTime}<br>
              Wind: ${windDir} at ${wind} knots${windGust}<br>
              Visibility: ${visibility} SM (${visibilityKm} km)<br>
              Weather: ${weather}<br>
              Clouds: ${clouds}<br>
              Temperature: ${temp}°C<br>
              Dewpoint: ${dewpoint}°C<br>
              Pressure: ${pressureInHg} inHg (${pressureHpa} hPa)`;
          }
        }

        // Fetch TAF using 2025 AviationWeather API JSON endpoint
        const tafResponse = await fetch(`https://aviationweather.gov/api/data/taf?ids=${icao}&format=json`, {
          headers: {
            'User-Agent': 'AirportWeatherApp/1.0'
          }
        });
        
        let tafDecoded = 'No TAF data available';
        if (tafResponse.ok && tafResponse.status !== 204) {
          const tafData = await tafResponse.json();
          if (tafData && tafData.length > 0) {
            const taf = tafData[0];
            const issueTime = formatTime(taf.issueTime);
            const validFrom = formatTime(taf.validTimeFrom);
            const validTo = formatTime(taf.validTimeTo);

            let forecastHtml = `<strong>TAF for ${airportName}</strong><br>
              Issued: ${issueTime}<br>
              Valid from ${validFrom} to ${validTo}<br><br>`;

            if (taf.fcsts && taf.fcsts.length > 0) {
              taf.fcsts.forEach((fcst, index) => {
                const fcstFrom = formatTime(fcst.fcstTimeFrom);
                const fcstTo = formatTime(fcst.fcstTimeTo);
                const isPast = isInPast(fcst.fcstTimeTo);
                const timeStyle = isPast ? 'text-decoration: line-through; opacity: 0.6;' : '';
                
                const changeIndicator = fcst.changeIndicator || '';
                const probability = fcst.probability ? `${fcst.probability}% chance ` : '';
                const timeBecoming = fcst.timeBecoming ? ` becoming ${formatTime(fcst.timeBecoming)}` : '';
                
                const fWind = fcst.wspd !== null && fcst.wspd !== undefined ? `${fcst.wspd}` : 'calm';
                const fWindDir = fcst.wdir !== null && fcst.wdir !== undefined ? `${fcst.wdir}°` : 'variable direction';
                const fWindGust = fcst.wgst ? ` gusting ${fcst.wgst} knots` : '';
                const fVisibility = fcst.visib !== null ? fcst.visib : 10;
                const fVisibilityKm = (fVisibility * 1.60934).toFixed(1);
                const fWxString = fcst.wxString || '';
                const fWeather = decodeWeather(fWxString) || 'none';
                
                let fClouds = 'clear skies';
                if (fcst.clouds && fcst.clouds.length > 0) {
                  fClouds = fcst.clouds.map(cloud => {
                    const cover = decodeCloudCover(cloud.cover);
                    const base = cloud.base ? ` at ${cloud.base} feet` : '';
                    return `${cover}${base}`;
                  }).join(', ');
                }

                const changeText = changeIndicator ? `${weatherTranslations[changeIndicator] || changeIndicator} ` : '';
                const probText = probability ? `${probability}` : '';
                
                forecastHtml += `<div style="${timeStyle}">
                  <strong>${probText}${changeText}${fcstFrom} to ${fcstTo}${timeBecoming}</strong><br>
                  Wind: ${fWindDir} at ${fWind} knots${fWindGust}<br>
                  Visibility: ${fVisibility} SM (${fVisibilityKm} km)<br>
                  Weather: ${fWeather}<br>
                  Clouds: ${fClouds}<br><br>
                </div>`;
              });
            }

            tafDecoded = forecastHtml;
          }
        }

        // Display results
        const highlighted = highlightText(metarDecoded + '<br><br>' + tafDecoded);
        weatherDiv.innerHTML = highlighted;

      } catch (error) {
        weatherDiv.innerHTML = `<p>Error fetching data: ${error.message}</p>`;
        console.error('Error:', error);
      }
    }
  </script>
</body>
</html>