<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>DHL Aviation Weerinfo</title>
  <style>
    body {
      font-family: sans-serif;
      margin: 0;
      padding: 0;
      background: #f9f9f9;
    }
    header {
      background-color: #FFD700; /* DHL Geel */
      padding: 20px;
      text-align: center;
      border-bottom: 5px solid #D2042D; /* DHL Rood */
    }
    header h1 {
      margin: 0;
      color: #8B0000; /* Donkerder Rood voor contrast */
    }
    .search-container {
      padding: 20px;
      text-align: center;
    }
    input[type="text"] {
      padding: 10px;
      width: 80%;
      max-width: 500px;
      font-size: 16px;
      border: 2px solid #ccc;
      border-radius: 5px;
    }
    input[type="text"]:disabled {
      background-color: #eee;
      cursor: not-allowed;
    }
    .search-status {
      font-style: italic;
      color: #666;
      margin-top: 5px;
      min-height: 1.2em; /* Reserveer ruimte om layout springen te voorkomen */
    }
    .search-results, .stations {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 20px;
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
    }
    .station {
      background: white;
      border: 2px solid #D2042D; /* DHL Rood */
      padding: 15px;
      border-radius: 8px;
      box-shadow: 2px 2px 5px rgba(0,0,0,0.1);
    }
    .station h2 {
      margin-top: 0;
      color: #D2042D; /* DHL Rood */
      font-size: 1.2em;
    }
    .station p {
       margin: 5px 0;
    }
    .station pre {
      background: #f0f0f0;
      padding: 10px;
      border-radius: 5px;
      white-space: pre-wrap; /* Zorgt dat lange regels afbreken */
      word-wrap: break-word; /* Zorgt dat lange woorden afbreken */
      font-family: monospace;
      font-size: 0.9em;
      border: 1px solid #ddd;
    }
    .stations-selector {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 10px;
      padding: 20px;
      background-color: #eee;
      border-bottom: 1px solid #ccc;
    }
    .station-button {
      background-color: #FFD700; /* DHL Geel */
      border: 2px solid #D2042D; /* DHL Rood */
      color: #8B0000; /* Donkerder Rood */
      padding: 10px 15px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: bold;
      transition: background-color 0.2s ease-in-out;
    }
    .station-button:hover {
      background-color: #ffe066; /* Lichtere Geel bij hover */
    }
    .error-message {
        color: red;
        font-weight: bold;
    }
  </style>
</head>
<body>
  <header>
    <h1>DHL Aviation â€“ Weerinfo</h1>
  </header>

  <h2>DHL Stations</h2>
  <section class="stations-selector" id="stationsSelector"></section>
  <section class="stations" id="stationsOutput"></section>

  <h2>Zoek Luchthaven Wereldwijd</h2>
   <section class="search-container">
    <input type="text" id="searchInput" placeholder="Laden van luchthavengegevens..." disabled />
    <div id="searchStatus" class="search-status">Laden...</div>
  </section>

  <section id="searchResult" class="search-results"></section>

  <script>
    // --- Configuratie ---
    const PREDEFINED_STATIONS = [
        // Jouw lijst met DHL stations blijft hier behouden
      { name: "Bahrein", icao: "OBBI", iata: "BAH" },
				{ name: "Barcelona", icao: "LEBL", iata: "BCN" },
				{ name: "Basel", icao: "LFSB", iata: "BSL" },
				{ name: "Bologna", icao: "LIPE", iata: "BLQ" },
				{ name: "Bordeaux", icao: "LFBD", iata: "BOD" },
				{ name: "Brussel", icao: "EBBR", iata: "BRU" },
				{ name: "Budapest", icao: "LHBP", iata: "BUD" },
				{ name: "Casablanca", icao: "GMMN", iata: "CMN" },
				{ name: "Cincinnati", icao: "KCVG", iata: "CVG" },
				{ name: "Dublin", icao: "EIDW", iata: "DUB" },
				{ name: "East-Midlands", icao: "EGNX", iata: "EMA" },
				{ name: "Hongkong", icao: "VHHH", iata: "HKG" },
				{ name: "Keulen", icao: "EDDK", iata: "CGN" },
				{ name: "Kopenhagen", icao: "EKCH", iata: "CPH" },
				{ name: "Lagos", icao: "DNMM", iata: "LOS" },
				{ name: "Leipzig", icao: "EDDP", iata: "LEJ" },
				{ name: "Linz", icao: "LOWL", iata: "LNZ" },
				{ name: "Londen", icao: "EGGW", iata: "LTN" },
				{ name: "Lyon", icao: "LFLL", iata: "LYS" },
				{ name: "Madrid", icao: "LEMD", iata: "MAD" },
				{ name: "Malpensa", icao: "LIMC", iata: "MXP" },
				{ name: "Marseille", icao: "LFML", iata: "MRS" },
				{ name: "Mulhouse", icao: "LFSB", iata: "MLH" },
				{ name: "Parijs", icao: "LFPG", iata: "CDG" },
				{ name: "Porto", icao: "LPPR", iata: "OPO" },
				{ name: "Riyad", icao: "OERK", iata: "RUH" },
				{ name: "Shanghai", icao: "ZSPD", iata: "PVG" },
				{ name: "Shenzhen", icao: "ZGSZ", iata: "SZX" },
				{ name: "Toulouse", icao: "LFBO", iata: "TLS" },
				{ name: "Vitoria", icao: "LEVT", iata: "VIT" },
    ];

    // URL naar een publieke dataset met luchthavencodes
    // Bron: https://github.com/datasets/airport-codes
    const AIRPORT_DATA_URL = 'https://raw.githubusercontent.com/datasets/airport-codes/master/data/airport-codes.json';
    const PROXY_URL = 'https://api.allorigins.win/raw?url='; // Proxy om CORS te omzeilen

    let allAirportsData = null; // Hier slaan we de wereldwijde luchthavendata op

    // --- DOM Elementen ---
    const stationsSelector = document.getElementById('stationsSelector');
    const stationsOutput = document.getElementById('stationsOutput');
    const searchInput = document.getElementById('searchInput');
    const searchStatus = document.getElementById('searchStatus');
    const searchResultContainer = document.getElementById('searchResult');

    // --- Functies ---

    /**
     * Haalt data op via een proxy om CORS-problemen te voorkomen.
     * @param {string} url De URL die opgehaald moet worden.
     * @returns {Promise<string>} Een promise die de tekstuele response bevat.
     */
    function fetchViaProxy(url) {
      console.log(`Workspaceing via proxy: ${url}`);
      return fetch(`${PROXY_URL}${encodeURIComponent(url)}`)
        .then(response => {
          if (!response.ok) {
            throw new Error(`Netwerkfout (${response.status}) bij ophalen via proxy: ${url}`);
          }
          return response.text();
        });
    }

    /**
     * Haalt METAR en TAF op voor een gegeven ICAO-code en toont deze in de opgegeven container.
     * @param {string} icao De ICAO-code van de luchthaven.
     * @param {string} containerIdPrefix Prefix voor de ID's van de pre-elementen (bv. 'zoek-EBBR' of 'station-EBBR').
     */
    function fetchMetarTaf(icao, containerIdPrefix) {
      const metarElement = document.getElementById(`${containerIdPrefix}-metar`);
      const tafElement = document.getElementById(`${containerIdPrefix}-taf`);

      if (!metarElement || !tafElement) {
          console.error(`Kan METAR/TAF elementen niet vinden voor prefix: ${containerIdPrefix}`);
          return;
      }

      // METAR ophalen
      fetchViaProxy(`https://aviationweather.gov/cgi-bin/data/metar.php?ids=${icao}&format=decoded&hours=0&taf=0&layout=off`)
        .then(data => {
          metarElement.textContent = data && data.trim() ? data.trim() : "Geen METAR beschikbaar.";
        })
        .catch(error => {
          console.error(`Fout bij ophalen METAR voor ${icao}:`, error);
          metarElement.textContent = `Fout bij ophalen METAR: ${error.message}`;
          metarElement.classList.add('error-message');
        });

      // TAF ophalen
      fetchViaProxy(`https://aviationweather.gov/cgi-bin/data/taf.php?ids=${icao}&format=decoded&hours=0&taf=1&layout=off`)
        .then(data => {
          tafElement.textContent = data && data.trim() ? data.trim() : "Geen TAF beschikbaar.";
        })
        .catch(error => {
          console.error(`Fout bij ophalen TAF voor ${icao}:`, error);
          tafElement.textContent = `Fout bij ophalen TAF: ${error.message}`;
          tafElement.classList.add('error-message');
        });
    }

    /**
     * Rendert de HTML voor een weerstation (METAR/TAF) in de opgegeven container.
     * @param {string} title De titel voor het station (bv. "Brussel (BRU)").
     * @param {string} icao De ICAO-code.
     * @param {string} iata De IATA-code (of '?').
     * @param {string} containerIdPrefix Een uniek prefix voor de element ID's.
     * @param {HTMLElement} container Het DOM-element waarin de output geplaatst moet worden.
     */
    function renderStation(title, icao, iata, containerIdPrefix, container) {
      // Voorkom dubbele weergave in dezelfde container
      if (document.getElementById(`${containerIdPrefix}-container`)) {
          console.log(`Station ${icao} wordt al weergegeven in deze sectie.`);
          // Optioneel: scroll naar bestaand element
          document.getElementById(`${containerIdPrefix}-container`).scrollIntoView({ behavior: 'smooth', block: 'center' });
          return;
      }

      const div = document.createElement("div");
      div.className = "station";
      div.id = `${containerIdPrefix}-container`; // ID voor de hele div
      div.innerHTML = `<h2>${title}</h2>
        <p><strong>ICAO:</strong> ${icao} | <strong>IATA:</strong> ${iata || 'N/A'}</p>
        <p><strong>METAR:</strong></p>
        <pre id="${containerIdPrefix}-metar" aria-live="polite">Laden...</pre>
        <p><strong>TAF:</strong></p>
        <pre id="${containerIdPrefix}-taf" aria-live="polite">Laden...</pre>`;
      container.appendChild(div);
      fetchMetarTaf(icao, containerIdPrefix);
    }


    /**
     * Zoekt naar luchthavens op basis van de invoer en toont de resultaten.
     */
    function searchWeather() {
      const query = searchInput.value.trim().toUpperCase();
      searchResultContainer.innerHTML = ""; // Maak vorige resultaten leeg

      if (!query) {
        searchStatus.textContent = "Voer een ICAO, IATA of naam in.";
        return;
      }

      if (!allAirportsData) {
        searchStatus.textContent = "Luchthavengegevens zijn nog niet geladen. Probeer het zo opnieuw.";
        return;
      }

      searchStatus.textContent = `Zoeken naar "${query}"...`;

      const results = allAirportsData.filter(airport => {
        const nameMatch = airport.name.toUpperCase().includes(query);
        const icaoMatch = airport.ident === query; // 'ident' is ICAO in deze dataset
        const iataMatch = airport.iata_code === query;
        return (nameMatch || icaoMatch || iataMatch);
      });

      if (results.length > 0) {
        searchStatus.textContent = `${results.length} resultaat/resultaten gevonden voor "${query}".`;
        const displayedIcaos = new Set(); // Om duplicaten te voorkomen als query op meerdere velden matcht
        results.forEach(airport => {
          if (airport.ident && !displayedIcaos.has(airport.ident)) { // Zorg dat we een ICAO hebben en deze nog niet getoond is
            const idPrefix = `zoek-${airport.ident}`;
            renderStation(
              `${airport.name} (${airport.iata_code || 'N/A'})`,
              airport.ident,
              airport.iata_code,
              idPrefix,
              searchResultContainer
            );
            displayedIcaos.add(airport.ident);
          }
        });
      } else {
        // Fallback: Als het een 4-letterige code is die niet in de data zit, toch proberen als ICAO
        if (query.length === 4 && /^[A-Z0-9]+$/.test(query)) {
             searchStatus.textContent = `"${query}" niet gevonden in database, probeer toch als ICAO...`;
             const idPrefix = `zoek-${query}`;
             renderStation(
                `Onbekende Locatie (${query})`,
                query,
                'N/A',
                idPrefix,
                searchResultContainer
            );
        } else {
            searchStatus.textContent = `Geen luchthavens gevonden voor "${query}". Probeer ICAO, IATA of een deel van de naam.`;
        }
      }
    }

    /**
     * Laadt de wereldwijde luchthavengegevens.
     */
    async function loadAirportData() {
      searchStatus.textContent = "Laden van luchthavengegevens...";
      searchInput.disabled = true;
      try {
        const response = await fetch(AIRPORT_DATA_URL);
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        const data = await response.json();

        // Filter alleen luchthavens met een ICAO code ('ident' in deze dataset) en type 'airport'
        allAirportsData = data.filter(item =>
            item.ident &&
            item.ident.length === 4 && // Basis ICAO check
            item.type && // Zorg dat 'type' bestaat
            !item.type.includes('closed') && // Sluit gesloten luchthavens uit
            (item.type.includes('airport')) // Alleen vliegvelden (klein, medium, groot, heliport)
        );

        console.log(`Totaal ${data.length} items geladen, ${allAirportsData.length} bruikbare luchthavens gefilterd.`);

        searchInput.placeholder = "Zoek op ICAO, IATA of naam (bv. EBBR, LHR, London)";
        searchInput.disabled = false;
        searchStatus.textContent = `Klaar. ${allAirportsData.length} luchthavens geladen.`;

      } catch (error) {
        console.error("Kon luchthavengegevens niet laden:", error);
        searchStatus.textContent = "Fout bij laden luchthavengegevens. Zoeken is beperkt.";
        searchInput.placeholder = "Fout bij laden data";
        // Zoekfunctie zal niet werken zonder allAirportsData
      }
    }

    // --- Initialisatie ---

    // Voeg event listener toe aan zoekveld (Enter key)
    searchInput.addEventListener("keydown", function (e) {
      if (e.key === "Enter") {
        e.preventDefault(); // Voorkom standaard formulierinzending
        searchWeather();
      }
    });

    // Maak knoppen voor vooraf gedefinieerde stations
    PREDEFINED_STATIONS
      .sort((a, b) => a.name.localeCompare(b.name)) // Sorteer op naam
      .forEach(station => {
        const btn = document.createElement("button");
        btn.textContent = `${station.name} (${station.iata || station.icao})`; // Toon IATA indien beschikbaar, anders ICAO
        btn.className = "station-button";
        btn.addEventListener("click", () => {
          // Gebruik een uniek prefix voor de button-sectie
          const idPrefix = `station-${station.icao}`;
           renderStation(
                `${station.name} (${station.iata || 'N/A'})`,
                station.icao,
                station.iata,
                idPrefix,
                stationsOutput // Toon in de sectie voor knop-resultaten
            );
        });
        stationsSelector.appendChild(btn);
    });

    // Start het laden van de wereldwijde luchthavengegevens
    loadAirportData();

  </script>
</body>
</html>
