<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Airport Weather</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body {
      background-color: #FFC107;
      color: #D40511;
    }
    button {
      background-color: #D40511;
      color: #FFFF00;
      width: 100%;
      text-align: center;
    }
    button:hover {
      background-color: #b0040e;
    }
    #weather-data {
      background-color: rgba(255, 255, 255, 0.9);
      color: #000000;
    }
    .highlight-red {
      background-color: #D40511;
      color: #FFFFFF;
      padding: 2px 4px;
      border-radius: 2px;
    }
    .highlight-orange {
      background-color: #F28C38;
      color: #FFFFFF;
      padding: 2px 4px;
      border-radius: 2px;
    }
    .grid-container {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 0.5rem;
      padding: 1rem;
      max-width: 1200px;
      width: 100%;
      box-sizing: border-box;
    }
    @media (max-width: 640px) {
      .grid-container {
        grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
        padding: 0.5rem;
      }
    }
  </style>
</head>
<body class="flex flex-col items-center justify-center min-h-screen p-4">
  <h1 class="text-3xl font-bold mb-6">Airport Weather Information</h1>

  <div class="grid-container">
    <button onclick="fetchWeather('EHAM', 'Amsterdam (AMS)')" class="px-4 py-2 rounded-lg font-semibold">Amsterdam (AMS)</button>
    <button onclick="fetchWeather('OBBI', 'Bahrain (BAH)')" class="px-4 py-2 rounded-lg font-semibold">Bahrain (BAH)</button>
    <button onclick="fetchWeather('LEBL', 'Barcelona (BCN)')" class="px-4 py-2 rounded-lg font-semibold">Barcelona (BCN)</button>
    <button onclick="fetchWeather('LFSB', 'Basel/Mulhouse (BSL/MLH)')" class="px-4 py-2 rounded-lg font-semibold">Basel/Mulhouse (BSL/MLH)</button>
    <button onclick="fetchWeather('LIPE', 'Bologna (BLQ)')" class="px-4 py-2 rounded-lg font-semibold">Bologna (BLQ)</button>
    <button onclick="fetchWeather('LFBD', 'Bordeaux (BOD)')" class="px-4 py-2 rounded-lg font-semibold">Bordeaux (BOD)</button>
    <button onclick="fetchWeather('EBBR', 'Brussels (BRU)')" class="px-4 py-2 rounded-lg font-semibold">Brussels (BRU)</button>
    <button onclick="fetchWeather('LHBP', 'Budapest (BUD)')" class="px-4 py-2 rounded-lg font-semibold">Budapest (BUD)</button>
    <button onclick="fetchWeather('GMMN', 'Casablanca (CMN)')" class="px-4 py-2 rounded-lg font-semibold">Casablanca (CMN)</button>
    <button onclick="fetchWeather('KCVG', 'Cincinnati (CVG)')" class="px-4 py-2 rounded-lg font-semibold">Cincinnati (CVG)</button>
    <button onclick="fetchWeather('EDDK', 'Cologne (CGN)')" class="px-4 py-2 rounded-lg font-semibold">Cologne (CGN)</button>
    <button onclick="fetchWeather('EKCH', 'Copenhagen (CPH)')" class="px-4 py-2 rounded-lg font-semibold">Copenhagen (CPH)</button>
    <button onclick="fetchWeather('EIDW', 'Dublin (DUB)')" class="px-4 py-2 rounded-lg font-semibold">Dublin (DUB)</button>
    <button onclick="fetchWeather('EGNX', 'East Midlands (EMA)')" class="px-4 py-2 rounded-lg font-semibold">East Midlands (EMA)</button>
    <button onclick="fetchWeather('VHHH', 'Hong Kong (HKG)')" class="px-4 py-2 rounded-lg font-semibold">Hong Kong (HKG)</button>
    <button onclick="fetchWeather('DNMM', 'Lagos (LOS)')" class="px-4 py-2 rounded-lg font-semibold">Lagos (LOS)</button>
    <button onclick="fetchWeather('EDDP', 'Leipzig (LEJ)')" class="px-4 py-2 rounded-lg font-semibold">Leipzig (LEJ)</button>
    <button onclick="fetchWeather('LOWL', 'Linz (LNZ)')" class="px-4 py-2 rounded-lg font-semibold">Linz (LNZ)</button>
    <button onclick="fetchWeather('EGLL', 'London Heathrow (LHR)')" class="px-4 py-2 rounded-lg font-semibold">London Heathrow (LHR)</button>
    <button onclick="fetchWeather('EGGW', 'Luton (LTN)')" class="px-4 py-2 rounded-lg font-semibold">Luton (LTN)</button>
    <button onclick="fetchWeather('LFLL', 'Lyon (LYS)')" class="px-4 py-2 rounded-lg font-semibold">Lyon (LYS)</button>
    <button onclick="fetchWeather('LEMD', 'Madrid (MAD)')" class="px-4 py-2 rounded-lg font-semibold">Madrid (MAD)</button>
    <button onclick="fetchWeather('LFML', 'Marseille (MRS)')" class="px-4 py-2 rounded-lg font-semibold">Marseille (MRS)</button>
    <button onclick="fetchWeather('LIMC', 'Milan Malpensa (MXP)')" class="px-4 py-2 rounded-lg font-semibold">Milan Malpensa (MXP)</button>
    <button onclick="fetchWeather('LFPG', 'Paris CDG (CDG)')" class="px-4 py-2 rounded-lg font-semibold">Paris CDG (CDG)</button>
    <button onclick="fetchWeather('LPPR', 'Porto (OPO)')" class="px-4 py-2 rounded-lg font-semibold">Porto (OPO)</button>
    <button onclick="fetchWeather('OERK', 'Riyadh (RUH)')" class="px-4 py-2 rounded-lg font-semibold">Riyadh (RUH)</button>
    <button onclick="fetchWeather('ZSPD', 'Shanghai (PVG)')" class="px-4 py-2 rounded-lg font-semibold">Shanghai (PVG)</button>
    <button onclick="fetchWeather('ZGSZ', 'Shenzhen (SZX)')" class="px-4 py-2 rounded-lg font-semibold">Shenzhen (SZX)</button>
    <button onclick="fetchWeather('LLBG', 'Tel Aviv (TLV)')" class="px-4 py-2 rounded-lg font-semibold">Tel Aviv (TLV)</button>
    <button onclick="fetchWeather('LFBO', 'Toulouse (TLS)')" class="px-4 py-2 rounded-lg font-semibold">Toulouse (TLS)</button>
    <button onclick="fetchWeather('LEVT', 'Vitoria (VIT)')" class="px-4 py-2 rounded-lg font-semibold">Vitoria (VIT)</button>
  </div>
  <div id="weather-data" class="w-full max-w-2xl p-6 rounded-lg shadow-lg mt-6">
    <p>Select an airport to view decoded METAR and TAF data.</p>
  </div>

  <script>
    const weatherTranslations = {
      'BR':'mist','TS':'thunderstorm','FG':'fog','HZ':'haze','FU':'smoke','FZ':'freezing','VA':'volcanic ash',
      'DU':'widespread dust','SQ':'squall','FC':'funnel cloud','PO':'dust devils','SA':'sand','CB':'cumulonimbus',
      'TCU':'towering cumulus','WS':'wind shear','+':'heavy ','-':'light ','VC':'in the vicinity ',
      'SHRA':'rain showers','-SHRA':'light rain showers','+SHRA':'heavy rain showers','-RA':'light rain','+RA':'heavy rain',
      '-SN':'light snow','+SN':'heavy snow','NOSIG':'no significant change expected','CAVOK':'ceiling and visibility ok',
      // Extend as needed...
    };

    const months = ['January','February','March','April','May','June','July','August','September','October','November','December'];

    function escapeRegExp(str){ return str.replace(/[.*+?^${}()|[\]\\]/g,'\\$&'); }

    function decodeWeather(wxString) {
      if (!wxString) return 'none';
      const codes = wxString.match(/[+-]?[A-Z]{2,4}/g) || [];
      return codes.map(code => weatherTranslations[code] || code).join(', ');
    }

    function highlightText(text, conditions, className) {
      let highlighted = text;
      conditions.forEach(condition => {
        const regex = new RegExp(`\\b${escapeRegExp(condition)}\\b`, 'gi');
        highlighted = highlighted.replace(regex, `<span class="${className}">${condition}</span>`);
      });
      return highlighted;
    }

    function decodeCloudCover(cover){
      return {FEW:'few clouds',SCT:'scattered clouds',BKN:'broken clouds',OVC:'overcast',
              NSC:'no significant cloud',CAVOK:'ceiling and visibility ok',CLR:'clear',SKC:'sky clear'}[cover] || cover;
    }

    function formatTime(isoTime){
      if(!isoTime)return 'Unknown';
      const d=new Date(isoTime);
      return `${d.getUTCDate().toString().padStart(2,'0')} ${months[d.getUTCMonth()]} ${d.getUTCHours().toString().padStart(2,'0')}:${d.getUTCMinutes().toString().padStart(2,'0')} UTC`;
    }

    function isInPast(isoTime){ return isoTime && new Date(isoTime) < new Date(); }

    async function fetchWeather(icao, airportName){
      const div=document.getElementById('weather-data');
      div.innerHTML='<p>Loading...</p>';
      try{
        // fetch METAR
        const metar = await fetchMETAR(icao);
        const taf = await fetchTAF(icao);
        div.innerHTML=`
          <h2 class="text-xl font-bold mb-2 text-[#D40511]">${airportName} Weather</h2>
          <h3 class="font-semibold">Decoded METAR</h3>
          <p>${metar||'No METAR data available'}</p>
          <h3 class="font-semibold mt-4">Decoded TAF</h3>
          <p>${taf||'No TAF data available'}</p>`;
      }catch(e){div.innerHTML=`<p>Error fetching data: ${e.message}</p>`;}
    }

    async function fetchMETAR(icao){
      const res=await fetch(`https://aviationweather.gov/api/data/metar?ids=${icao}&format=xml`);
      const txt=await res.text();
      const xml=new DOMParser().parseFromString(txt,'text/xml');
      const node=xml.querySelector('METAR');
      if(!node)return null;

      const observationTime = formatTime(node.querySelector('observation_time')?.textContent);
      let wind = node.querySelector('wind_speed_kt')?.textContent || 'Unknown';
      const windDir = node.querySelector('wind_dir_degrees')?.textContent || '';
      const windGust = node.querySelector('wind_gust_kt')?.textContent || null;
      let visibility = node.querySelector('visibility_statute_mi')?.textContent || '10';
      const visibilityKm = isNaN(parseFloat(visibility)) ? visibility : (parseFloat(visibility) * 1.60934);
      const temp = node.querySelector('temp_c')?.textContent || 'Unknown';
      const dewpoint = node.querySelector('dewpoint_c')?.textContent || 'Unknown';
      const pressureInHg = node.querySelector('altim_in_hg')?.textContent || 'Unknown';
      const pressure = pressureInHg !== 'Unknown' ? (parseFloat(pressureInHg) * 33.8639).toFixed(0) : 'Unknown';
      const clouds = node.querySelectorAll('sky_condition');
      let cloudLayers = [];
      let lowestCeiling = null;
      let hasCavok = false;
      clouds.forEach(cloud => {
        const cover = cloud.getAttribute('sky_cover');
        const baseStr = cloud.getAttribute('cloud_base_ft_agl');
        const base = baseStr ? parseInt(baseStr) : null;
        if (cover === 'CAVOK') { hasCavok = true; }
        if ((cover === 'BKN' || cover === 'OVC') && base && (!lowestCeiling || base < lowestCeiling)) {
          lowestCeiling = base;
        }
        const decodedCover = decodeCloudCover(cover).toLowerCase();
        cloudLayers.push(decodedCover + (base ? ` at ${base} ft` : ''));
      });
      let cloudText = cloudLayers.join(', ') || 'clear';
      const wxString = node.querySelector('wx_string')?.textContent || '';

      // Apply highlighting
      let visibilityText = typeof visibilityKm === 'number' ? `${visibilityKm.toFixed(1)} km` : visibilityKm;
      if (typeof visibilityKm === 'number' && visibilityKm <= 0.56) visibilityText = `<span class="highlight-red">${visibilityText}</span>`;
      else if (typeof visibilityKm === 'number' && visibilityKm <= 0.81) visibilityText = `<span class="highlight-orange">${visibilityText}</span>`;
        
      if (wind !== 'Unknown') {
        if (windDir === 'VRB') {
          wind = `${wind} kt variable direction`;
        } else {
          const windSpeed = parseInt(wind);
          if (windSpeed >= 26) wind = `<span class="highlight-red">${windSpeed} kt from ${windDir}°</span>`;
          else if (windSpeed >= 21) wind = `<span class="highlight-orange">${windSpeed} kt from ${windDir}°</span>`;
          else wind = `${windSpeed} kt from ${windDir}°`;
        }
      }
        
      if (windGust) {
        const gustSpeed = parseInt(windGust);
        if (gustSpeed >= 36) wind += `, gusts <span class="highlight-red">${gustSpeed} kt</span>`;
        else if (gustSpeed >= 25) wind += `, gusts <span class="highlight-orange">${gustSpeed} kt</span>`;
      }
        
      if (lowestCeiling) {
        if (lowestCeiling <= 200) cloudText = `<span class="highlight-red">${cloudText}</span>`;
        else if (lowestCeiling <= 399) cloudText = `<span class="highlight-orange">${cloudText}</span>`;
      }
        
      const decodedWx = decodeWeather(wxString);
      const highlightedWx = highlightText(decodedWx, Object.values(weatherTranslations), 'highlight-red');

      if (hasCavok) {
        visibilityText = '10 km or more';
        cloudText = 'ceiling and visibility ok';
      }

      return `
        Observation time: ${observationTime}<br>
        ${wind && wind !== 'Unknown' ? `Wind: ${wind}<br>` : ''}
        Visibility: ${visibilityText}<br>
        Clouds: ${cloudText}<br>
        ${highlightedWx && highlightedWx !== 'none' ? `Weather: ${highlightedWx}<br>` : ''}
        Temperature & Dewpoint: ${temp}°C / ${dewpoint}°C<br>
        Pressure: ${pressure} hPa
      `;
    }

    async function fetchTAF(icao){
      const res=await fetch(`https://aviationweather.gov/api/data/taf?ids=${icao}&format=xml`);
      const txt=await res.text();
      const xml=new DOMParser().parseFromString(txt,'text/xml');
      const node=xml.querySelector('TAF');
      if(!node)return null;

      const forecast = [];
      const fcstGroups = node.querySelectorAll('forecast');
      fcstGroups.forEach(fc => {
        const timeTo = fc.querySelector('fcst_time_to')?.textContent;
        if (isInPast(timeTo)) return; // Skip past forecast periods
        const timeFrom = formatTime(fc.querySelector('fcst_time_from')?.textContent);
        const timeToText = formatTime(timeTo);
        let wind = fc.querySelector('wind_speed_kt')?.textContent || 'Unknown';
        const windDir = fc.querySelector('wind_dir_degrees')?.textContent || '';
        const windGust = fc.querySelector('wind_gust_kt')?.textContent || null;
        let visibility = fc.querySelector('visibility_statute_mi')?.textContent || '10';
        const visibilityKm = isNaN(parseFloat(visibility)) ? visibility : (parseFloat(visibility) * 1.60934);
        const clouds = fc.querySelectorAll('sky_condition');
        let cloudLayers = [];
        let lowestCeiling = null;
        let hasCavok = false;
        clouds.forEach(cloud => {
          const cover = cloud.getAttribute('sky_cover');
          const baseStr = cloud.getAttribute('cloud_base_ft_agl');
          const base = baseStr ? parseInt(baseStr) : null;
          if (cover === 'CAVOK') hasCavok = true;
          if ((cover === 'BKN' || cover === 'OVC') && base && (!lowestCeiling || base < lowestCeiling)) {
            lowestCeiling = base;
          }
          const decodedCover = decodeCloudCover(cover).toLowerCase();
          cloudLayers.push(decodedCover + (base ? ` at ${base} ft` : ''));
        });
        let cloudText = cloudLayers.join(', ') || 'clear';
        const wxString = fc.querySelector('wx_string')?.textContent || '';
        const changeIndicator = fc.querySelector('change_indicator')?.textContent || '';
        const change = changeIndicator ? decodeWeather(changeIndicator) + ' ' : '';

        let visibilityText = typeof visibilityKm === 'number' ? `${visibilityKm.toFixed(1)} km` : visibilityKm;
        if (typeof visibilityKm === 'number' && visibilityKm <= 0.56) visibilityText = `<span class="highlight-red">${visibilityText}</span>`;
        else if (typeof visibilityKm === 'number' && visibilityKm <= 0.81) visibilityText = `<span class="highlight-orange">${visibilityText}</span>`;
            
        if (wind !== 'Unknown') {
          if (windDir === 'VRB') {
            wind = `${wind} kt variable direction`;
          } else {
            const windSpeed = parseInt(wind);
            if (windSpeed >= 26) wind = `<span class="highlight-red">${windSpeed} kt from ${windDir}°</span>`;
            else if (windSpeed >= 21) wind = `<span class="highlight-orange">${windSpeed} kt from ${windDir}°</span>`;
            else wind = `${windSpeed} kt from ${windDir}°`;
          }
        }
            
        if (windGust) {
          const gustSpeed = parseInt(windGust);
          if (gustSpeed >= 36) wind += `, gusts <span class="highlight-red">${gustSpeed} kt</span>`;
          else if (gustSpeed >= 25) wind += `, gusts <span class="highlight-orange">${gustSpeed} kt</span>`;
        }
            
        if (lowestCeiling) {
          if (lowestCeiling <= 200) cloudText = `<span class="highlight-red">${cloudText}</span>`;
          else if (lowestCeiling <= 399) cloudText = `<span class="highlight-orange">${cloudText}</span>`;
        }
            
        const decodedWx = decodeWeather(wxString);
        const highlightedWx = highlightText(decodedWx, Object.values(weatherTranslations), 'highlight-red');

        if (hasCavok) {
          visibilityText = '10 km or more';
          cloudText = 'ceiling and visibility ok';
        }

        forecast.push(`
          ${change}${timeFrom} to ${timeToText}:<br>
          ${wind && wind !== 'Unknown' ? '&nbsp;&nbsp;Wind: '+wind+'<br>' : ''}
          &nbsp;&nbsp;Visibility: ${visibilityText}<br>
          &nbsp;&nbsp;Clouds: ${cloudText}<br>
          ${highlightedWx && highlightedWx !== 'none' ? '&nbsp;&nbsp;Weather: '+highlightedWx+'<br>' : ''}
        `);
      });
      return forecast.length > 0 ? forecast.join('<br><br>') : 'No TAF data available';
    }
  </script>
</body>
</html>
