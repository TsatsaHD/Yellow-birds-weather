<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Airport Weather — METAR &amp; TAF</title>

  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    :root{
      --brand-red: #d40511;
      --brand-red-dark: #b0040e;
      --brand-yellow: #ffc107;
      --panel-bg: rgba(255,255,255,0.98);
      --muted: #4b5563;
    }
    html,body { height:100%; }
    body{
      background: linear-gradient(180deg, var(--brand-yellow), #fff6d6 60%);
      color: var(--brand-red);
      font-family: Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
    }
    header{ width:100%; }
    .airport-btn{
      background: var(--brand-red);
      color: var(--brand-yellow);
      border-radius: 0.5rem;
      transition: transform .06s ease, background-color .12s ease;
      white-space: normal;
    }
    .airport-btn:hover{ background: var(--brand-red-dark); transform: translateY(-2px); }
    .card{ background: var(--panel-bg); border-radius: 12px; box-shadow: 0 8px 24px rgba(0,0,0,0.06); }
    .mono{ font-family: ui-monospace,SFMono-Regular,Menlo,Monaco,"Roboto Mono","Courier New",monospace; }
    .muted{ color: var(--muted); }
    .highlight-red { background-color: var(--brand-red); color: #fff; padding: 2px 6px; border-radius: 3px; font-weight:700; }
    .highlight-orange { background-color: #f28c38; color: #fff; padding: 2px 6px; border-radius: 3px; font-weight:700; }
    /* responsive grid */
    @media (max-width: 640px){
      .airport-grid { grid-template-columns: repeat(2, minmax(0,1fr)); gap:0.5rem; }
    }
  </style>
</head>
<body class="min-h-screen flex flex-col items-center p-6">

  <header class="w-full max-w-6xl mb-6">
    <div class="mx-auto max-w-6xl flex items-center justify-between py-6 px-2">
      <div class="flex items-center gap-4">
        <div class="w-12 h-12 rounded-lg bg-gradient-to-br from-[#ffd24a] to-[#ffb300] flex items-center justify-center shadow-sm">
          <svg width="22" height="22" viewBox="0 0 24 24" fill="none" aria-hidden>
            <path d="M2 12h20M12 2v20" stroke="var(--brand-red)" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </div>
        <div>
          <h1 class="text-2xl font-extrabold" style="color:var(--brand-red)">Airport Weather</h1>
          <div class="text-sm muted">Decoded METAR &amp; TAF (interactive)</div>
        </div>
      </div>

      <div class="text-sm mono muted">Live METAR & TAF</div>
    </div>
  </header>

  <main class="w-full max-w-6xl flex-1 flex gap-6 flex-col lg:flex-row">
    <!-- Left: Buttons -->
    <section class="lg:w-2/5">
      <div class="card p-4">
        <div class="flex items-center justify-between mb-3">
          <h2 class="text-lg font-semibold" style="color:var(--brand-red)">Airports</h2>
          <div class="text-xs muted">Click to load METAR &amp; TAF</div>
        </div>

        <div id="airport-grid" class="airport-grid grid grid-cols-3 gap-3" role="list" aria-label="Airport list">
          <!-- Buttons generated by script -->
        </div>

        <div class="mt-4 flex gap-3">
          <button id="refresh-last" class="px-3 py-2 airport-btn text-sm font-semibold">Refresh last</button>
          <button id="clear-btn" class="px-3 py-2 border border-dashed rounded text-sm muted">Clear</button>
          <div id="last-loaded" class="ml-auto text-xs muted self-center mono">None</div>
        </div>
      </div>
    </section>

    <!-- Right: Weather display -->
    <section class="lg:w-3/5">
      <div id="weather-panel" class="card p-6 min-h-[320px]">
        <div id="panel-header" class="flex items-start justify-between gap-4 mb-4">
          <div>
            <h3 id="airport-title" class="text-xl font-bold" style="color:var(--brand-red)">Select an airport</h3>
            <div id="observ-time" class="text-sm muted">Decoded METAR &amp; TAF will appear here.</div>
          </div>
          <div class="text-right text-sm muted">
            <div id="status">Idle</div>
            <div id="updated" class="mono text-xs"></div>
          </div>
        </div>

        <div id="weather-content" class="overflow-auto" style="max-height:58vh;">
          <p class="muted">No data loaded. Use the left panel to pick an airport.</p>
        </div>

      </div>
    </section>
  </main>

  <footer class="w-full max-w-6xl mt-6">
    <div class="text-xs muted text-center">Interface for METAR &amp; TAF decoding and highlighting.</div>
  </footer>

  <script>
    /* --------------------------
       Airports (same set as original)
       -------------------------- */
    const AIRPORTS = [
      ['EHAM','Amsterdam (AMS)'],
      ['OBBI','Bahrain (BAH)'],
      ['LEBL','Barcelona (BCN)'],
      ['LFSB','Basel/Mulhouse (BSL/MLH)'],
      ['LIPE','Bologna (BLQ)'],
      ['LFBD','Bordeaux (BOD)'],
      ['EBBR','Brussels (BRU)'],
      ['LHBP','Budapest (BUD)'],
      ['GMMN','Casablanca (CMN)'],
      ['KCVG','Cincinnati (CVG)'],
      ['EDDK','Cologne (CGN)'],
      ['EKCH','Copenhagen (CPH)'],
      ['EIDW','Dublin (DUB)'],
      ['EGNX','East Midlands (EMA)'],
      ['VHHH','Hong Kong (HKG)'],
      ['DNMM','Lagos (LOS)'],
      ['EDDP','Leipzig (LEJ)'],
      ['LOWL','Linz (LNZ)'],
      ['EGLL','London Heathrow (LHR)'],
      ['EGGW','Luton (LTN)'],
      ['LFLL','Lyon (LYS)'],
      ['LEMD','Madrid (MAD)'],
      ['LFML','Marseille (MRS)'],
      ['LIMC','Milan Malpensa (MXP)'],
      ['LFPG','Paris CDG (CDG)'],
      ['LPPR','Porto (OPO)'],
      ['OERK','Riyadh (RUH)'],
      ['ZSPD','Shanghai (PVG)'],
      ['ZGSZ','Shenzhen (SZX)'],
      ['LLBG','Tel Aviv (TLV)'],
      ['LFBO','Toulouse (TLS)'],
      ['LEVT','Vitoria (VIT)']
    ];

    /* --------------------------
       Translations & helpers (from your original)
       -------------------------- */
    const weatherTranslations = {
      'BR': 'mist','TS': 'thunderstorm','FG': 'fog','HZ': 'haze','FU': 'smoke','FZ': 'freezing',
      'VA': 'volcanic ash','DU': 'widespread dust','SQ': 'squall','FC': 'funnel cloud','PO': 'dust devils',
      'SA': 'sand','CB': 'cumulonimbus','TCU': 'towering cumulus','WS': 'wind shear',
      '+': 'heavy ','-': 'light ','VC': 'in the vicinity ',
      'FZRA': 'freezing rain','NSW': 'no significant weather','ALQDS': 'all quadrants',
      'FM': 'from','VRB': 'variable direction','BCFG': 'patches of fog','MIFG': 'shallow fog',
      'PRFG': 'partial fog','DRSN': 'drifting snow','BLSN': 'blowing snow','MIBR': 'shallow mist',
      'PRBR': 'partial mist','DRDU': 'drifting dust','DRSA': 'drifting sand','BLDU': 'blowing dust',
      'BLSA': 'blowing sand','BECMG': 'becoming','TEMPO': 'temporary fluctuations',
      'PROB30': '30% chance','PROB40': '40% chance','NOSIG': 'no significant change expected',
      'RA':'rain','DZ':'drizzle','SN':'snow','SG':'snow grains','IC':'ice crystals',
      'PL':'ice pellets','GR':'hail','GS':'small hail or snow pellets','UP':'unknown precipitation',
      'SHRA':'rain showers','SHSN':'snow showers','TSRA':'thunderstorm with rain','TSGR':'thunderstorm with hail'
    };

    const months = ['January','February','March','April','May','June','July','August','September','October','November','December'];

    function escapeRegExp(str){ return str.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'); }
    function escapeHtml(s){ if(!s) return ''; return String(s).replace(/[&<>"']/g, function(m){ return ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'})[m]; }); }

    function decodeWeather(wxString){
      if(!wxString) return 'none';
      const codes = wxString.match(/PROB(?:30|40)|[+-]?[A-Z]{2,4}/g) || [];
      return codes.map(code => weatherTranslations[code] || code).join(', ');
    }

    function decodeCloudCover(cover){
      switch(cover){
        case 'FEW': return 'few clouds';
        case 'SCT': return 'scattered clouds';
        case 'BKN': return 'broken clouds';
        case 'OVC': return 'overcast';
        case 'NSC': return 'no significant clouds';
        case 'CAVOK': return 'ceiling and visibility ok';
        case 'CLR': case 'SKC': return 'clear';
        default: return cover;
      }
    }

    function formatTime(isoTime){
      if(!isoTime) return 'Unknown';
      const d = new Date(isoTime);
      const day = String(d.getUTCDate()).padStart(2,'0');
      const month = months[d.getUTCMonth()];
      const hours = String(d.getUTCHours()).padStart(2,'0');
      const minutes = String(d.getUTCMinutes()).padStart(2,'0');
      return `${day} ${month} ${hours}:${minutes} UTC`;
    }

    function isInPast(isoTime){
      if(!isoTime) return false;
      return new Date(isoTime) < new Date();
    }

    /* Highlighting logic — preserve original heuristics */
    function highlightText(htmlText){
      const orangeList = ['mist','shallow mist','partial mist'];
      const ignoreList = [
        'rain','light rain','heavy rain','rain showers','light rain showers','heavy rain showers',
        'drizzle','light drizzle','heavy drizzle','no significant weather','no significant change expected',
        'light ','heavy '
      ];

      let highlighted = htmlText;
      const uniqueConditions = Array.from(new Set(Object.values(weatherTranslations).filter(Boolean)));
      uniqueConditions.forEach(condition => {
        const condLower = condition.toLowerCase();
        if(ignoreList.includes(condLower)) return;
        const regex = new RegExp('\\b' + escapeRegExp(condition) + '\\b','gi');
        if(orangeList.includes(condLower)){
          highlighted = highlighted.replace(regex, `<span class="highlight-orange">${condition}</span>`);
        } else {
          highlighted = highlighted.replace(regex, `<span class="highlight-red">${condition}</span>`);
        }
      });

      return highlighted;
    }

    /* --------------------------
       DOM refs & state
       -------------------------- */
    const grid = document.getElementById('airport-grid');
    const weatherContent = document.getElementById('weather-content');
    const airportTitle = document.getElementById('airport-title');
    const observTime = document.getElementById('observ-time');
    const statusEl = document.getElementById('status');
    const updatedEl = document.getElementById('updated');
    const lastLoadedEl = document.getElementById('last-loaded');
    const refreshBtn = document.getElementById('refresh-last');
    const clearBtn = document.getElementById('clear-btn');

    let lastStation = null;
    let lastData = null;

    /* Build buttons (ensures every airport is clickable) */
    function buildButtons(){
      AIRPORTS.forEach(([icao,label])=>{
        const btn = document.createElement('button');
        btn.className = 'airport-btn px-3 py-2 text-sm font-semibold';
        btn.setAttribute('role','listitem');
        btn.innerHTML = `${escapeHtml(label)} <span class="mono text-xs ml-2">(${icao})</span>`;
        btn.title = `${label} — ${icao}`;
        btn.addEventListener('click', ()=> fetchWeather(icao,label));
        grid.appendChild(btn);
      });
    }
    buildButtons();

    clearBtn.addEventListener('click', ()=>{
      weatherContent.innerHTML = '<p class="muted">Cleared. Select an airport to load data.</p>';
      airportTitle.textContent = 'Select an airport';
      observTime.textContent = 'Decoded METAR & TAF will appear here.';
      statusEl.textContent = 'Idle';
      updatedEl.textContent = '';
      lastStation = null;
      lastData = null;
      lastLoadedEl.textContent = 'None';
    });

    refreshBtn.addEventListener('click', ()=>{
      if(lastStation) fetchWeather(lastStation[0], lastStation[1], {force:true});
      else {
        statusEl.textContent = 'Nothing to refresh';
        setTimeout(()=> statusEl.textContent = 'Idle', 1400);
      }
    });

    /* ------------- Fetching helpers ------------- */
    async function fetchJSON(url){
      const resp = await fetch(url, { headers: { 'User-Agent': 'AirportWeatherWidget/1.0' } });
      if(!resp.ok){
        const txt = await resp.text().catch(()=> '');
        throw new Error(`HTTP ${resp.status} ${resp.statusText} ${txt ? '- ' + txt : ''}`);
      }
      return resp.json();
    }

    function extractWxFromRaw(raw){
      if(!raw) return '';
      const matches = raw.match(/PROB(?:30|40)|[+-]?[A-Z]{2,4}/g) || [];
      return matches.join(' ');
    }

    /* --------------------------
       Core: fetch METAR & TAF, decode, highlight
       -------------------------- */
    async function fetchWeather(icao, airportName, opts={force:false}){
      airportTitle.textContent = `${airportName} (${icao})`;
      observTime.textContent = 'Loading METAR & TAF...';
      statusEl.textContent = 'Fetching';
      updatedEl.textContent = new Date().toISOString();
      weatherContent.innerHTML = `<p class="muted">Loading data for ${icao}...</p>`;

      try {
        const metarUrl = `https://aviationweather.gov/api/data/metar?ids=${icao}&format=json`;
        const tafUrl = `https://aviationweather.gov/api/data/taf?ids=${icao}&format=json`;

        const [metarRes, tafRes] = await Promise.allSettled([fetchJSON(metarUrl), fetchJSON(tafUrl)]);

        let metarDecoded = 'No METAR data available';
        if(metarRes.status === 'fulfilled' && Array.isArray(metarRes.value) && metarRes.value.length > 0){
          const m = metarRes.value[0];
          const observationTime = m.reportTime ? formatTime(m.reportTime) : (m.observed ? formatTime(m.observed) : 'Unknown');
          const wind = (m.wspd !== null && m.wspd !== undefined) ? `${m.wspd}` : 'calm';
          const windDir = (m.wdir !== null && m.wdir !== undefined) ? `${m.wdir}°` : 'variable direction';
          const windGust = m.wgst ? ` gusting ${m.wgst} knots` : '';
          const visibility = (m.visib !== null && m.visib !== undefined) ? m.visib : (m.visibility ? m.visibility : 10);
          const visibilityKm = (visibility * 1.60934).toFixed(1);
          const temp = (m.temp !== null && m.temp !== undefined) ? `${m.temp}` : 'Unknown';
          const dew = (m.dewp !== null && m.dewp !== undefined) ? `${m.dewp}` : 'Unknown';
          const pressureInHg = (m.altim !== null && m.altim !== undefined) ? (m.altim.toFixed ? m.altim.toFixed(2) : m.altim) : 'Unknown';
          const pressureHpa = (m.altim !== null && m.altim !== undefined) ? Math.round(m.altim * 33.8639) : 'Unknown';
          const wxString = m.wxString || (m.rawText ? extractWxFromRaw(m.rawText) : '');
          const weather = decodeWeather(wxString) || 'none';

          let clouds = 'clear skies';
          if(Array.isArray(m.clouds) && m.clouds.length > 0){
            clouds = m.clouds.map(c => {
              const cover = decodeCloudCover(c.cover || c['cover']);
              const base = c.base ? ` at ${c.base} feet` : '';
              return `${cover}${base}`;
            }).join(', ');
          } else if (m.rawText && /(FEW|SCT|BKN|OVC|CAVOK)/.test(m.rawText)){
            const match = m.rawText.match(/(FEW|SCT|BKN|OVC|CAVOK)/);
            clouds = match ? match[0] : 'see raw';
          }

          metarDecoded = `<div>
            <div class="text-sm muted mono">Observation: ${escapeHtml(observationTime)}</div>
            <div class="mt-2"><strong>Wind:</strong> ${escapeHtml(windDir)} at ${escapeHtml(wind)} kt${escapeHtml(windGust)}</div>
            <div><strong>Visibility:</strong> ${escapeHtml(String(visibility))} SM (${escapeHtml(visibilityKm)} km)</div>
            <div><strong>Weather:</strong> ${escapeHtml(weather)}</div>
            <div><strong>Clouds:</strong> ${escapeHtml(clouds)}</div>
            <div><strong>Temperature:</strong> ${escapeHtml(String(temp))}°C · <strong>Dewpoint:</strong> ${escapeHtml(String(dew))}°C</div>
            <div><strong>Pressure:</strong> ${escapeHtml(String(pressureInHg))} inHg (${escapeHtml(String(pressureHpa))} hPa)</div>
          </div>`;
        } else {
          metarDecoded = `<div class="muted">No METAR returned for ${escapeHtml(icao)}.</div>`;
        }

        // TAF
        let tafDecoded = 'No TAF data available';
        if(tafRes.status === 'fulfilled' && Array.isArray(tafRes.value) && tafRes.value.length > 0){
          const t = tafRes.value[0];
          const issueTime = t.issueTime ? formatTime(t.issueTime) : 'Unknown';
          const validFrom = t.validTimeFrom ? formatTime(t.validTimeFrom) : 'Unknown';
          const validTo = t.validTimeTo ? formatTime(t.validTimeTo) : 'Unknown';
          let forecastHtml = `<div class="mt-4"><div class="text-sm muted mono">TAF issued: ${escapeHtml(issueTime)}</div>
            <div class="mt-2"><strong>Valid:</strong> ${escapeHtml(validFrom)} — ${escapeHtml(validTo)}</div>`;

          if(Array.isArray(t.fcsts) && t.fcsts.length > 0){
            t.fcsts.forEach(fcst => {
              const fcstFrom = fcst.fcstTimeFrom ? formatTime(fcst.fcstTimeFrom) : 'Unknown';
              const fcstTo = fcst.fcstTimeTo ? formatTime(fcst.fcstTimeTo) : 'Unknown';
              const past = isInPast(fcst.fcstTimeTo);
              const timeStyle = past ? 'opacity:0.55;text-decoration:line-through;' : '';
              const changeIndicator = fcst.changeIndicator || '';
              const prob = fcst.probability ? `${fcst.probability}% chance ` : '';
              const timeBecoming = fcst.timeBecoming ? ` becoming ${formatTime(fcst.timeBecoming)}` : '';

              const fWind = (fcst.wspd !== null && fcst.wspd !== undefined) ? `${fcst.wspd}` : 'calm';
              const fWindDir = (fcst.wdir !== null && fcst.wdir !== undefined) ? `${fcst.wdir}°` : 'variable direction';
              const fWindGust = fcst.wgst ? ` gusting ${fcst.wgst} kt` : '';
              const fVis = (fcst.visib !== null && fcst.visib !== undefined) ? fcst.visib : 10;
              const fVisKm = (fVis * 1.60934).toFixed(1);
              const fWxString = fcst.wxString || '';
              const fWeather = decodeWeather(fWxString) || 'none';

              let fClouds = 'clear skies';
              if(Array.isArray(fcst.clouds) && fcst.clouds.length > 0){
                fClouds = fcst.clouds.map(c => {
                  const cover = decodeCloudCover(c.cover || c['cover']);
                  const base = c.base ? ` at ${c.base} feet` : '';
                  return `${cover}${base}`;
                }).join(', ');
              }

              const changeText = changeIndicator ? (weatherTranslations[changeIndicator] || changeIndicator) + ' ' : '';
              forecastHtml += `<div style="${timeStyle} margin-top:0.5rem; padding:0.5rem 0;">
                <div><strong>${escapeHtml(prob)}${escapeHtml(changeText)}${escapeHtml(fcstFrom)} to ${escapeHtml(fcstTo)}${escapeHtml(timeBecoming)}</strong></div>
                <div>Wind: ${escapeHtml(fWindDir)} at ${escapeHtml(fWind)} kt${escapeHtml(fWindGust)}</div>
                <div>Visibility: ${escapeHtml(String(fVis))} SM (${escapeHtml(fVisKm)} km)</div>
                <div>Weather: ${escapeHtml(fWeather)}</div>
                <div>Clouds: ${escapeHtml(fClouds)}</div>
              </div>`;
            });
          } else if (t.rawText) {
            forecastHtml += `<div class="muted mt-2 mono">${escapeHtml(t.rawText)}</div>`;
          }

          forecastHtml += '</div>';
          tafDecoded = forecastHtml;
        } else {
          tafDecoded = `<div class="muted">No TAF returned for ${escapeHtml(icao)}.</div>`;
        }

        // Combine & highlight
        const combined = `<div>${metarDecoded}<hr class="my-3" /><div>${tafDecoded}</div></div>`;
        const highlighted = highlightText(combined);

        weatherContent.innerHTML = highlighted;
        observTime.textContent = `Last loaded: ${new Date().toLocaleString()}`;
        statusEl.textContent = 'OK';
        updatedEl.textContent = `Updated: ${new Date().toISOString()}`;

        lastStation = [icao, airportName];
        lastData = { metarRes, tafRes, rendered: highlighted, fetchedAt: new Date().toISOString() };
        lastLoadedEl.textContent = `${icao}`;

      } catch (err) {
        weatherContent.innerHTML = `<div class="text-red-700"><strong>Error:</strong> ${escapeHtml(err.message)}</div>`;
        statusEl.textContent = 'Error';
        updatedEl.textContent = '';
        console.error(err);
      }
    }

    /* ------------- End script ------------- */
  </script>
</body>
</html>